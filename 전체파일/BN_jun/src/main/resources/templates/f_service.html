<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë°˜ë ¤ë™ë¬¼ ì¥ë¡€ì‹ì¥ - ì¥ë¡€ì•ˆë‚´</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + ${ncpMapClientId} + '&submodules=geocoder'}"></script>

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/f_service.css}">
</head>

<body>
<div class="header-wrapper">
    <header>
        <div class="logo">
            <a href="#"><img th:src="@{/asset/LastPageë¡œê³ _íˆ¬ëª….png}" alt="ë¡œê³ " /></a>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="#">í™ˆ</a>
                    <ul><li><a href="#">ì¸ì‚¬ë§</a></li></ul>
                </li>
                <li><a href="#">ì¥ë¡€ì„œë¹„ìŠ¤</a></li>
                <li><a href="#">Ourpage</a></li>
                <li>
                    <a href="#">ì‹¬ë¦¬ìƒë‹´</a>
                    <ul>
                        <li><a href="#">ìƒë‹´ì˜ˆì•½</a></li>
                        <li><a href="#">ì˜ˆì•½ì¡°íšŒ</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">ì¶”ëª¨êµ¿ì¦ˆ</a>
                    <ul>
                        <li><a href="#">êµ¿ì¦ˆì†Œê°œ</a></li>
                        <li><a href="#">êµ¿ì¦ˆì˜ˆì•½</a></li>
                        <li><a href="#">ì˜ˆì•½ì¡°íšŒ</a></li>
                    </ul>
                </li>
                <li><a href="#">ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="#">ê³ ê°ì„¼í„°</a></li>
            </ul>
        </nav>
        <div class="auth">
            <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </header>
</div>

<section class="banner" role="img" aria-label="ë”°ëœ»í•œ í«ë¡œìŠ¤ ì‹¬ë¦¬ìƒë‹´ ë°°ë„ˆ ì´ë¯¸ì§€">
    <div class="inner">
        <h1>ì‘ë³„ì˜ ìˆœê°„, í˜¼ì ë‘ì§€ ì•Šê² ìŠµë‹ˆë‹¤</h1>
        <p>ê·¸ë¦¬ì›€ì´ ì•„í”„ì§€ ì•Šë„ë¡, ê¸°ì–µì„ ì²œì²œíˆ ë‹¤ë…ì…ë‹ˆë‹¤.</p>
    </div>
</section>

<main>
    <div class="wrap">
        <h1 class="title">í˜‘ë ¥ ì¥ë¡€ì‹ì¥ ì•ˆë‚´</h1>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ì§€ë„ ë¡œë”© ì¤‘..." disabled>
            <button id="searchButton" disabled>ê²€ìƒ‰</button>
        </div>

        <div class="grid">
            <div id="map" aria-label="ì¥ë¡€ì‹ì¥ ìœ„ì¹˜ ì§€ë„"></div>
            <div class="list-container" id="placeList">
            </div>
        </div>
    </div>
</main>

<footer>
    ëŒ€ì¶© ì—°ë½ì²˜ / GitHub ì£¼ì†Œ / ì´ë©”ì¼ ë“± ì…ë ¥ ì˜ˆì •/ í‘¸í„° ë†’ì´ëŠ” í—¤ë” ë°°ë„ˆ ë°˜ì‘ í…ŒìŠ¤íŠ¸ìš©.
</footer>

<script>
    (function () {
      const header = document.querySelector('header');
      window.addEventListener('scroll', () => {
        header.style.top = (window.scrollY > 120) ? '-80px' : '0';
      });
    })();
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {

        // --- 1. DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ---
        const PLACES = /*[[${places}]]*/ [];

        // --- 2. ì „ì—­ ë³€ìˆ˜ ë° ì§€ë„ ì´ˆê¸°í™” ---
        const mapEl = document.getElementById("map");
        const placeListEl = document.getElementById("placeList");
        const searchInput = document.getElementById("searchInput");
        const searchButton = document.getElementById("searchButton");

        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        if (!naver || !naver.maps) {
            console.error("Naver Maps SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            mapEl.innerHTML = "<div style='text-align:center; padding: 20px;'>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>NCP í´ë¼ì´ì–¸íŠ¸ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>";
            searchInput.placeholder = "ì§€ë„ ë¡œë“œ ì‹¤íŒ¨";
            return;
        }

        // ì§€ë„ ì˜µì…˜
        const mapOptions = {
            center: new naver.maps.LatLng(36.8714, 127.6014), // ëŒ€í•œë¯¼êµ­ ì¤‘ì‹¬
            zoom: 8,
            minZoom: 7,
            draggable: true,
            scrollWheel: true,
            disableDoubleClickZoom: false,
            disableDoubleTapZoom: false,
            pinchZoom: true,
            keyboardShortcuts: true,
        };
        const map = new naver.maps.Map("map", mapOptions);

        const markers = {};
        const placeCards = {};
        const infoWindow = new naver.maps.InfoWindow({
            content: '',
            maxWidth: 300,
            backgroundColor: "#fff",
            borderColor: "#e0d8cc",
            borderWidth: 1,
            anchorSize: new naver.maps.Size(10, 10),
            anchorSkew: true,
            pixelOffset: new naver.maps.Point(20, -20)
        });

        // --- 3. í•µì‹¬ í•¨ìˆ˜ ---

        // 1. ëª©ë¡ ì¹´ë“œ HTML ìƒì„±
        function createPlaceCardElement(place) {
            const servicesHTML = (place.services || [])
                .map(s => `<span class="chip">${s}</span>`).join('');

            const cardDiv = document.createElement('div');
            cardDiv.className = 'place-card';
            cardDiv.dataset.id = place.id;
            cardDiv.innerHTML = `
                <h3>${place.name}</h3>
                <p class="addr">${place.address}</p>
                <p class="phone">${place.phone}</p>
                <div class="chips">${servicesHTML}</div>
                <div class="links">
                    <a href="#" onclick="alert('í›„ê¸° ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'); return false;">í›„ê¸° ë³´ê¸°</a>
                    <a href="${place.homepageUrl || '#'}" target="_blank" rel="noopener noreferrer">í™ˆí˜ì´ì§€</a>
                </div>
            `;

            cardDiv.addEventListener("click", function () {
                const id = cardDiv.dataset.id;
                const marker = markers[id];
                if (marker) {
                    map.panTo(marker.getPosition(), { duration: 300 });
                    naver.maps.Event.trigger(marker, 'click');
                    highlightActiveCard(id);
                }
            });
            return cardDiv;
        }

        // 2. ì •ë³´ì°½ ë‚´ìš© HTML ìƒì„±
        function createInfoWindowContent(place) {
            return `
                <div style="padding:10px; min-width:200px; line-height:1.6;">
                    <h5 style="margin:0 0 5px; font-weight:600; color: #2C3930;">${place.name}</h5>
                    <p style="font-size:13px; margin:0;">${place.address}</p>
                    <p style="font-size:13px; margin:0; color:#a2725c; font-weight: 500;">${place.phone}</p>
                    <a href="${place.homepageUrl || '#'}" target="_blank" rel="noopener noreferrer" style="font-size:13px; color:#007bff; text-decoration:none;">í™ˆí˜ì´ì§€ ë°©ë¬¸</a>
                </div>
            `;
        }

        // 3. (Promise) ì£¼ì†Œ -> ì¢Œí‘œ ë³€í™˜
        function geocodeAddress(place) {
            return new Promise((resolve, reject) => {
                if (place.latitude && place.longitude) {
                    place.coords = new naver.maps.LatLng(place.latitude, place.longitude);
                    resolve(place);
                    return;
                }

                naver.maps.Service.geocode({ query: place.address }, (status, response) => {
                    if (status !== naver.maps.Service.Status.OK || !response.v2.addresses.length) {
                        console.warn(`[${place.name}] ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ${place.address}`);
                        reject(new Error("Geocoding failed"));
                        return;
                    }
                    const coords = response.v2.addresses[0];
                    place.coords = new naver.maps.LatLng(coords.y, coords.x);
                    resolve(place);
                });
            });
        }

        // 4. í™œì„± ì¹´ë“œ í‘œì‹œ
        function highlightActiveCard(id) {
            $$(".place-card").forEach(card => card.classList.remove("active"));
            const activeCard = $(`.place-card[data-id="${id}"]`);
            if (activeCard) {
                activeCard.classList.add("active");
            }
        }

        // 5. [ê¸°ëŠ¥ 1] ê²€ìƒ‰ ê¸°ëŠ¥ í•¸ë“¤ëŸ¬
        function handleSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const foundPlace = PLACES.find(place =>
                place.name.toLowerCase().includes(query)
            );

            if (foundPlace) {
                const marker = markers[foundPlace.id];

                if (marker) {
                    map.panTo(marker.getPosition(), { duration: 500 });
                    naver.maps.Event.trigger(marker, 'click');
                    highlightActiveCard(foundPlace.id);
                } else {
                    alert('"' + foundPlace.name + '"ì˜ ì£¼ì†Œ ì¢Œí‘œë¥¼ ë³€í™˜í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } else {
                alert('"' + query + '"ì™€(ê³¼) ì¼ì¹˜í•˜ëŠ” ì¥ë¡€ì‹ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // --- 4. ì§€ë„ ì‹¤í–‰ (ìˆ˜ì •ëœ ë²„ì „) ---
        async function initMap() {
            try {

                // 1. (ì¶”ê°€) ì»¤ìŠ¤í…€ ë§ˆì»¤ ì•„ì´ì½˜ì„ ì •ì˜í•©ë‹ˆë‹¤. (ë£¨í”„ ë°–ì—ì„œ í•œ ë²ˆë§Œ)
                // (ê²½ë¡œ ì˜ˆì‹œ: /asset/marker-paw.png)
                const customIcon = {
                    url: '/asset/marker-paw.png', // ğŸ¾ ë°œë°”ë‹¥ ë§ˆì»¤ ì´ë¯¸ì§€ ê²½ë¡œ
                    size: new naver.maps.Size(32, 32),
                    scaledSize: new naver.maps.Size(32, 32),
                    anchor: new naver.maps.Point(16, 32) // (x: í¬ê¸°ì˜ ì ˆë°˜, y: í¬ê¸°)
                };

                for (const place of PLACES) {
                    try {
                        await geocodeAddress(place); // ì£¼ì†Œ -> ì¢Œí‘œ ë³€í™˜

                        if (place.coords) {
                            // 2. (ìˆ˜ì •) ë§ˆì»¤ë¥¼ 'map: map'ìœ¼ë¡œ ì¦‰ì‹œ ì§€ë„ì— ì¶”ê°€
                            const marker = new naver.maps.Marker({
                                position: place.coords,
                                map: map, // ğŸ‘ˆ ì¦‰ì‹œ ì§€ë„ì— í‘œì‹œ
                                title: place.name,
                                icon: customIcon // ğŸ‘ˆ ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì ìš©
                            });

                            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ (ì •ë³´ì°½)
                            naver.maps.Event.addListener(marker, 'click', function() {
                                infoWindow.setContent(createInfoWindowContent(place));
                                infoWindow.open(map, marker);
                                highlightActiveCard(place.id);
                            });

                            // 3. (ìˆ˜ì •) ëª©ë¡ ì¹´ë“œë¥¼ 'block'ìœ¼ë¡œ ì¦‰ì‹œ í‘œì‹œ
                            const card = createPlaceCardElement(place);
                            card.style.display = 'block'; // ğŸ‘ˆ ì¦‰ì‹œ ëª©ë¡ì— í‘œì‹œ
                            placeListEl.appendChild(card);

                            markers[place.id] = marker;
                            placeCards[place.id] = card;
                        }
                    } catch (geoError) {
                        console.warn(`[${place.name}] ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, geoError.message);
                    }
                }

                // 4. (ì‚­ì œ) í•„í„°ë§ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ëª¨ë‘ ì œê±°

                // 5. ê²€ìƒ‰ ë²„íŠ¼ ë° ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                searchButton.addEventListener('click', handleSearch);
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleSearch();
                });
                naver.maps.Event.addListener(map, 'click', function() {
                    infoWindow.close();
                    $$(".place-card").forEach(card => card.classList.remove("active"));
                });

                // 6. (ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„) ê²€ìƒ‰ì°½ í™œì„±í™”
                searchInput.disabled = false;
                searchButton.disabled = false;
                searchInput.placeholder = "ì¥ë¡€ì‹ì¥ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...";
                console.log("ì§€ë„ ë° ì¥ì†Œ ë¡œë”© ì™„ë£Œ (ëª¨ë“  ë§ˆì»¤ ì¦‰ì‹œ í‘œì‹œ).");

            } catch (error) {
                console.error("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                mapEl.innerHTML = "<div style='text-align:center; padding: 20px;'>ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
                searchInput.placeholder = "ì§€ë„ ì˜¤ë¥˜";
            }
        }

        // ì§€ë„ ì´ˆê¸°í™” ì‹¤í–‰!
        initMap();
    });
    /*]]>*/
</script>
</body>
</html>