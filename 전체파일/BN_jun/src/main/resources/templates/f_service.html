<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>반려동물 장례식장 - 장례안내</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + ${ncpMapClientId} + '&submodules=geocoder'}"></script>

    <!-- AOS (애니메이션) CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/f_service.css}">
</head>

<body>
<div class="header-wrapper">
    <header>
        <div class="logo">
            <a href="#"><img th:src="@{/asset/LastPage로고_투명.png}" alt="로고" /></a>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="#">홈</a>
                    <ul><li><a href="#">인사말</a></li></ul>
                </li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li>
                    <a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </nav>
        <div class="auth">
            <a href="#">로그아웃</a>
        </div>
    </header>
</div>

<!-- 섹션 1: 배너 -->
<section class="full-screen-section banner" role="img" aria-label="따뜻한 펫로스 심리상담 배너 이미지"
         th:style="'background-image: url(' + @{/asset/장례서비스배너.jpg} + ');'">

    <div class="inner" data-aos="fade-up" data-aos-duration="2000" data-aos-easing="ease-out-cubic">
        <h1>작별의 순간, 혼자 두지 않겠습니다</h1>
        <p>그리움이 아프지 않도록, 기억을 천천히 다독입니다.</p>
    </div>
</section>

<!-- 섹션 2: 문구 레이아웃 (시안 6-3 풀스크린 중앙 정렬 + 내용 보강) -->
<section class="full-screen-section text-section-v6-full"
         th:style="'padding: 100px 40px; color: #e8e6e3; text-align: center; ' +
                   'background-image: linear-gradient(rgba(43, 38, 35, 0.85), rgba(43, 38, 35, 0.85)), url(' + @{/asset/장례서비스설명.jpg} + '); ' +
                   'background-size: cover; background-position: center;'">

    <div class="wrap" style="max-width: 900px;"
         data-aos="fade-up" data-aos-duration="2000" data-aos-delay="100" data-aos-easing="ease-out-cubic">
        <h3 style="color: #C1A38E; font-size: 1rem; margin-bottom: 20px; font-weight: 500; letter-spacing: 3px; opacity: 0.8;">CORE VALUES</h3>
        <h2 style="font-size: 3rem; margin-bottom: 50px; line-height: 1.2; font-family: serif; letter-spacing: -1px;">변치 않는 약속</h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 50px 40px; text-align: left;">

            <div style="display: flex; gap: 20px;">
                <div style="color: #C1A38E; font-size: 1.8rem;">✦</div>
                <div>
                    <h4 style="font-size: 1.3rem; color: #fff; margin-bottom: 12px; font-weight: 500;">24시간 케어</h4>
                    <p style="color: #999; font-weight: 300; line-height: 1.7; word-break: keep-all;">
                        갑작스러운 이별은 시간과 장소를 가리지 않습니다. 한밤중이나 새벽에도 당황하지 않도록, LastPage의 반려동물 전문 장례 지도사가 24시간 대기하며 보호자님의 첫 전화부터 마지막 순간까지 1:1로 전담 케어합니다.
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="color: #C1A38E; font-size: 1.8rem;">✦</div>
                <div>
                    <h4 style="font-size: 1.3rem; color: #fff; margin-bottom: 12px; font-weight: 500;">투명한 절차</h4>
                    <p style="color: #999; font-weight: 300; line-height: 1.7; word-break: keep-all;">
                        소중한 가족을 보내는 경황없는 와중에도 불안함을 느끼시지 않도록, 모든 장례 과정을 처음부터 끝까지 투명하게 공개합니다. 염습, 입관, 화장 등 전 과정을 참관실에서 함께하며 반려동물의 마지막 길을 지켜볼 수 있습니다.
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="color: #C1A38E; font-size: 1.8rem;">✦</div>
                <div>
                    <h4 style="font-size: 1.3rem; color: #fff; margin-bottom: 12px; font-weight: 500;">맞춤형 서비스</h4>
                    <p style="color: #999; font-weight: 300; line-height: 1.7; word-break: keep-all;">
                        반려동물과 함께한 추억이 모두 다르듯, 추모의 방식도 달라야 합니다. 일반적인 장례 외에도 유골을 보석으로 만드는 '메모리얼 스톤', '수목장', '맞춤 굿즈' 등 소중한 존재를 가장 잘 기억할 수 있는 특별한 방식을 제안합니다.
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="color: #C1A38E; font-size: 1.8rem;">✦</div>
                <div>
                    <h4 style="font-size: 1.3rem; color: #fff; margin-bottom: 12px; font-weight: 500;">사후 관리</h4>
                    <p style="color: #999; font-weight: 300; line-height: 1.7; word-break: keep-all;">
                        장례가 끝난 후 찾아오는 깊은 상실감(펫로스 증후군)을 이해합니다. 반려동물을 떠나보낸 뒤에도 건강하게 애도 과정을 이겨내실 수 있도록, 전문 심리 상담 센터와의 연계를 통해 보호자님의 마음까지 세심하게 돌봅니다.
                    </p>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- 섹션 3: 지도 레이아웃 -->
<section class="map-section">
    <!-- [수정] 내부 wrap div에 data-aos 적용 (떨림 방지) -->
    <div class="wrap map-content"
         data-aos="fade-up" data-aos-duration="1200" data-aos-delay="100" data-aos-easing="ease-out-cubic">
        <h1 class="title">협력 장례식장 안내</h1>

        <p class="page-description">
            라스트페이지와 협력하는 전국 반려동물 장례식장 위치를 안내합니다.<br>
            가까운 장례식장을 찾아보고, 소중한 아이의 마지막을 함께하세요.
        </p>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="지도 로딩 중..." disabled>
            <button id="searchButton" disabled>검색</button>
        </div>

        <div class="grid">
            <div id="map" aria-label="장례식장 위치 지도"></div>
            <div class="list-container" id="placeList">
            </div>
        </div>
    </div>
</section>

<footer>
    대충 연락처 / GitHub 주소 / 이메일 등 입력 예정/ 푸터 높이는 헤더 배너 반응 테스트용.
</footer>

<!-- AOS JS 및 설정 -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init({
        once: false, // 반복 실행
        threshold: 0.3,
        duration: 800
    });
</script>

<script>
    (function () {
      const header = document.querySelector('header');
      window.addEventListener('scroll', () => {
        header.style.top = (window.scrollY > 120) ? '-80px' : '0';
      });
    })();
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", function () {

        // --- 1. DB 데이터 가져오기 ---
        const PLACES = /*[[${places}]]*/ [];

        // --- 2. 전역 변수 및 지도 초기화 ---
        const mapEl = document.getElementById("map");
        const placeListEl = document.getElementById("placeList");
        const searchInput = document.getElementById("searchInput");
        const searchButton = document.getElementById("searchButton");

        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        if (!naver || !naver.maps) {
            console.error("Naver Maps SDK가 로드되지 않았습니다.");
            mapEl.innerHTML = "<div style='text-align:center; padding: 20px;'>지도를 불러오는 데 실패했습니다.<br>NCP 클라이언트 ID를 확인해주세요.</div>";
            searchInput.placeholder = "지도 로드 실패";
            return;
        }

        // 지도 옵션
        const mapOptions = {
            center: new naver.maps.LatLng(36.8714, 127.6014), // 대한민국 중심
            zoom: 8,
            minZoom: 7,
            draggable: true,
            scrollWheel: true,
            disableDoubleClickZoom: false,
            disableDoubleTapZoom: false,
            pinchZoom: true,
            keyboardShortcuts: true,
        };
        const map = new naver.maps.Map("map", mapOptions);

        const markers = {};
        const placeCards = {};
        const infoWindow = new naver.maps.InfoWindow({
            content: '',
            maxWidth: 300,
            backgroundColor: "#fff",
            borderColor: "#e0d8cc",
            borderWidth: 1,
            anchorSize: new naver.maps.Size(10, 10),
            anchorSkew: true,
            pixelOffset: new naver.maps.Point(20, -20)
        });

        // --- 3. 핵심 함수 ---

        // 1. 목록 카드 HTML 생성
        function createPlaceCardElement(place) {
            const servicesHTML = (place.services || [])
                .map(s => `<span class="chip">${s}</span>`).join('');

            const cardDiv = document.createElement('div');
            cardDiv.className = 'place-card';
            cardDiv.dataset.id = place.id;
            cardDiv.innerHTML = `
                <h3>${place.name}</h3>
                <p class="addr">${place.address}</p>
                <p class="phone">${place.phone}</p>
                <div class="chips">${servicesHTML}</div>
                <div class="links">
                    <a href="#" onclick="alert('후기 기능 준비 중입니다.'); return false;">후기 보기</a>
                    <a href="${place.homepageUrl || '#'}" target="_blank" rel="noopener noreferrer">홈페이지</a>
                </div>
            `;

            cardDiv.addEventListener("click", function () {
                const id = cardDiv.dataset.id;
                const marker = markers[id];
                if (marker) {
                    map.panTo(marker.getPosition(), { duration: 300 });
                    naver.maps.Event.trigger(marker, 'click');
                    highlightActiveCard(id);
                }
            });
            return cardDiv;
        }

        // 2. 정보창 내용 HTML 생성
        function createInfoWindowContent(place) {
            return `
                <div style="padding:10px; min-width:200px; line-height:1.6;">
                    <h5 style="margin:0 0 5px; font-weight:600; color: #2C3930;">${place.name}</h5>
                    <p style="font-size:13px; margin:0;">${place.address}</p>
                    <p style="font-size:13px; margin:0; color:#a2725c; font-weight: 500;">${place.phone}</p>
                    <a href="${place.homepageUrl || '#'}" target="_blank" rel="noopener noreferrer" style="font-size:13px; color:#007bff; text-decoration:none;">홈페이지 방문</a>
                </div>
            `;
        }

        // 3. (Promise) 주소 -> 좌표 변환
        function geocodeAddress(place) {
            return new Promise((resolve, reject) => {
                if (place.latitude && place.longitude) {
                    place.coords = new naver.maps.LatLng(place.latitude, place.longitude);
                    resolve(place);
                    return;
                }

                naver.maps.Service.geocode({ query: place.address }, (status, response) => {
                    if (status !== naver.maps.Service.Status.OK || !response.v2.addresses.length) {
                        console.warn(`[${place.name}] 지오코딩 실패: ${place.address}`);
                        reject(new Error("Geocoding failed"));
                        return;
                    }
                    const coords = response.v2.addresses[0];
                    place.coords = new naver.maps.LatLng(coords.y, coords.x);
                    resolve(place);
                });
            });
        }

        // 4. 활성 카드 표시
        function highlightActiveCard(id) {
            $$(".place-card").forEach(card => card.classList.remove("active"));
            const activeCard = $(`.place-card[data-id="${id}"]`);
            if (activeCard) {
                activeCard.classList.add("active");
            }
        }

        // 5. [기능 1] 검색 기능 핸들러
        function handleSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                alert('검색어를 입력해주세요.');
                return;
            }

            const foundPlace = PLACES.find(place =>
                place.name.toLowerCase().includes(query)
            );

            if (foundPlace) {
                const marker = markers[foundPlace.id];

                if (marker) {
                    map.panTo(marker.getPosition(), { duration: 500 });
                    naver.maps.Event.trigger(marker, 'click');
                    highlightActiveCard(foundPlace.id);
                } else {
                    alert('"' + foundPlace.name + '"의 주소 좌표를 변환하는 데 실패했습니다. 주소를 확인해주세요.');
                }
            } else {
                alert('"' + query + '"와(과) 일치하는 장례식장을 찾을 수 없습니다.');
            }
        }

        // --- 4. 지도 실행 ---
        async function initMap() {
            try {
                // 커스텀 마커 (SVG)
                const customIcon = {
                    url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjE4IiBmaWxsPSIjRjBGMEYwIiBzdHJva2U9IiNFMEUwRTAiIHN0cm9rZS13aWR0aD0iMSIvPgogICAgPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xOS45OTk5IDEyLjAwMDFDMTguNjY2NiAxMi4wMDAxIDE3LjU4MzMgMTMuMDgzNCAxNy41ODMzIDE0LjQxNjhDMTcuNTgzMyAxNS43NTAxIDE4LjY2NjYgMTYuODMzNCAxOS45OTk5IDE2LjgzMzRDMjEuMzMzMyAxNi44MzM0IDIyLjQxNjYgMTUuNzUwMSAyMi40MTY2IDE0LjQxNjhDMjIuNDE2NiAxMy4wODM0IDIxLjMzMzMgMTIuMDAwMSAxOS45OTk5IDEyLjAwMDFaTTE0LjQxNjYgMTYuMDAwMUMxMy4wODMzIDE2LjAwMDEgMTIgMTcuMDgzNCAxMiAxOC40MTY4QzEyIDE5Ljc1MDEgMTMuMDgzMyAyMC44MzM0IDE0LjQxNjYgMjAuODMzNEMxNS43NSAyMC44MzM0IDE2LjgzMzMgMTkuNzUwMSAxNi44MzMzIDE4LjQxNjhDMTYuODMzMyAxNy42ODM0IDE1Ljc1IDE2LjAwMDEgMTQuNDc5OSAxNi4wMDAxWk0yNS41ODMzIDE2LjAwMDFDMjQuMjQ5OSAxNi4wMDAxIDIzLjE2NjYgMTcuMDgzNCAyMy4xNjY2IDE4LjQxNjhDMjMuMTY2NiAxOS43NTAxIDI0LjI0OTkgMjAuODMzNCAyNS41ODMzIDIwLjgzMzRDMjYuOTE2NiAyMC44MzM0IDI4IDE5Ljc1MDEgMjggMTguNDQxNjhDMjggMTcuMDgzNCAyNi45MTY2IDE2LjAwMDEgMjUuNTgzMyAxNi4wMDAxWk0yMC4wMDAxIDE4LjkxNjdDMTcuNzY2NyAxOC45MTY3IDE1Ljk2ODggMjAuNjc2IDE1LjkxODkgMjIuOTA5OUMxNS44NjkgMjUuMTQzOCAxNy42MTg2IDI2Ljk2MzQgMTkuODUyNSAyNy4wMTMzQzIyLjA4NjQgMjcuMDYzMiAyMy45MDYgMjUuMzEzNSAyMy45NTU5IDIzLjA3OTZDMjQuMDA1OCAyMC44NDU3IDIyLjI1NjIgMTkuMDI2MSAyMC4wMDAxIDE4LjkxNjdaiIgZmlsbD0iI0EyN0I1QyIvPgo8L3N2Zz4=',
                    size: new naver.maps.Size(40, 40),
                    scaledSize: new naver.maps.Size(40, 40),
                    anchor: new naver.maps.Point(20, 40)
                };

                for (const place of PLACES) {
                    try {
                        await geocodeAddress(place);
                        if (place.coords) {
                            const marker = new naver.maps.Marker({
                                position: place.coords,
                                map: map,
                                title: place.name,
                                icon: customIcon
                            });
                            naver.maps.Event.addListener(marker, 'click', function() {
                                infoWindow.setContent(createInfoWindowContent(place));
                                infoWindow.open(map, marker);
                                highlightActiveCard(place.id);
                            });
                            const card = createPlaceCardElement(place);
                            card.style.display = 'block';
                            placeListEl.appendChild(card);
                            markers[place.id] = marker;
                            placeCards[place.id] = card;
                        }
                    } catch (geoError) {
                        console.warn(`[${place.name}] 처리 중 오류:`, geoError.message);
                    }
                }

                searchButton.addEventListener('click', handleSearch);
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleSearch();
                });
                naver.maps.Event.addListener(map, 'click', function() {
                    infoWindow.close();
                    $$(".place-card").forEach(card => card.classList.remove("active"));
                });

                searchInput.disabled = false;
                searchButton.disabled = false;
                searchInput.placeholder = "장례식장 이름으로 검색...";
                console.log("지도 로딩 완료.");

            } catch (error) {
                console.error("지도 초기화 중 오류 발생:", error);
                mapEl.innerHTML = "<div style='text-align:center; padding: 20px;'>지도 초기화 중 오류가 발생했습니다.</div>";
                searchInput.placeholder = "지도 오류";
            }
        }

        initMap();
    });
    /*]]>*/
</script>
</body>
</html>