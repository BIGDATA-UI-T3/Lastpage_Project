<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì¶”ëª¨ êµ¿ì¦ˆ ê°„í¸ì˜ˆì•½</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS: ê³µí†µ ë¨¼ì €, í˜ì´ì§€ ì „ìš© ë‚˜ì¤‘ -->
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/Goods_reserve.css}">
</head>
<body>

<script th:if="${existingData}" th:inline="javascript">
    /*[CDATA[*/
    // 1-1. ì„œë²„ì—ì„œ ì „ë‹¬ëœ 'GoodsReserve' ì—”í‹°í‹°
    const serverData = /*[[${existingData}]]*/ null;

    // 1-2. ì´ ì˜ˆì•½ì˜ ê³ ìœ  IDë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
    window.RESERVATION_ID = serverData.id;

    // 1-3. ì—”í‹°í‹° ë°ì´í„°ë¥¼ JS í¼ ê°ì²´(ST) êµ¬ì¡°ë¡œ ë³€í™˜
    //      [ìˆ˜ì •] ëª¨ë“  í•„ë“œì— '||(or)' ì—°ì‚°ìë¥¼ ì¶”ê°€í•˜ì—¬ null ì•ˆì •ì„± í™•ë³´
    window.initialST = {
        ownerName: serverData.ownerName || '',
        ownerPhone: serverData.ownerPhone || '',
        ownerEmail: serverData.ownerEmail || '',
        ownerAddr: serverData.ownerAddr || '',
        petName: serverData.petName || '',
        petType: serverData.petType || '',
        petBreed: serverData.petBreed || '',
        petWeight: serverData.petWeight || '',
        memo: serverData.memo || '',
        materials: serverData.materials ? serverData.materials.split(',') : [],
        product: serverData.product || '',
        metalColor: serverData.metalColor || '',
        chainLength: serverData.chainLength || '',
        ringSize: serverData.ringSize || '',
        quantity: serverData.quantity || 1, // ìˆ˜ëŸ‰ì€ nullì´ë©´ 1ë¡œ
        engravingText: serverData.engravingText || '',
        engravingFont: serverData.engravingFont || '',
        optionsMemo: serverData.optionsMemo || '',
        shipMethod: serverData.shipMethod || '',
        targetDate: serverData.targetDate || '',
        isExpress: serverData.isExpress || false, // booleanì€ falseë¡œ
        kitAddr: serverData.kitAddr || '',
        kitDate: serverData.kitDate || '',
        kitTime: serverData.kitTime || '',
        visitDate: serverData.visitDate || '',
        visitTime: serverData.visitTime || '',
        trackingInfo: serverData.trackingInfo || ''
    };
    /*]]>*/
</script>

<!-- í—¤ë”(ë©”ì¸ê³¼ ë™ì¼) -->
<div class="header-wrapper">
    <header>
        <div class="logo">
            <a href="#"><img th:src="@{/asset/LastPageë¡œê³ _íˆ¬ëª….png}" alt="ë¡œê³ " /></a>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="#">í™ˆ</a>
                    <ul><li><a href="#">ì¸ì‚¬ë§</a></li></ul>
                </li>
                <li><a href="#">ì¥ë¡€ì„œë¹„ìŠ¤</a></li>
                <li><a href="#">Ourpage</a></li>
                <li>
                    <a href="#">ì‹¬ë¦¬ìƒë‹´</a>
                    <ul>
                        <li><a href="#">ìƒë‹´ì˜ˆì•½</a></li>
                        <li><a href="#">ì˜ˆì•½ì¡°íšŒ</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">ì¶”ëª¨êµ¿ì¦ˆ</a>
                    <ul>
                        <li><a href="#">êµ¿ì¦ˆì†Œê°œ</a></li>
                        <li><a href="#">êµ¿ì¦ˆì˜ˆì•½</a></li>
                        <li><a href="#">ì˜ˆì•½ì¡°íšŒ</a></li>
                    </ul>
                </li>
                <li><a href="#">ë§ˆì´í˜ì´ì§€</a></li>
                <li><a href="#">ê³ ê°ì„¼í„°</a></li>
            </ul>
        </nav>
        <div class="auth">
            <a href="#">ë¡œê·¸ì¸</a>
            <a href="#">íšŒì›ê°€ì…</a>
        </div>
    </header>

    <!-- ë°°ë„ˆ -->
    <section class="banner" role="img" aria-label="ì¶”ëª¨ êµ¿ì¦ˆ ê°„í¸ì˜ˆì•½ ë°°ë„ˆ">
        <div class="inner">
            <h1>ì‚¬ë‘ì„ í˜•íƒœë¡œ ë‚¨ê¸°ëŠ” ë§ì¶¤ ì œì‘</h1>
            <p>ìœ ê³¨Â·ëª¨ë°œÂ·ë°œìêµ­ ë“± ì†Œì¤‘í•œ í”ì ìœ¼ë¡œ ì£¼ì–¼ë¦¬/ì•¡ì/ë ˆì§„ ì˜¤ë¸Œì œë¥¼ ì œì‘í•©ë‹ˆë‹¤.</p>
        </div>
    </section>
</div>

<!-- ë³¸ë¬¸: ì¶”ëª¨ êµ¿ì¦ˆ ê°„í¸ì˜ˆì•½ í¼ -->
<main>
    <div class="wrap">
        <div class="card">
            <div class="steps" aria-label="ì˜ˆì•½ ë‹¨ê³„">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
                <div class="step-dot" id="dot4"></div>
            </div>

            <h1 class="title">ì¶”ëª¨ êµ¿ì¦ˆ ê°„í¸ì˜ˆì•½</h1>

            <!-- STEP 1 : ì‹ ì²­ì/ë°˜ë ¤ë™ë¬¼ & ë³´ê´€ ì¤‘ì¸ í”ì  -->
            <section class="step active" id="step1">
                <div class="grid">
                    <div>
                        <label class="small">ì‹ ì²­ìëª…</label>
                        <div class="field"><input id="ownerName" type="text" placeholder="í™ê¸¸ë™" required></div>
                    </div>
                    <div>
                        <label class="small">íœ´ëŒ€í°ë²ˆí˜¸</label>
                        <div class="field"><input id="ownerPhone" type="tel" inputmode="numeric" placeholder="01012345678" required></div>
                    </div>
                    <div>
                        <label class="small">ì´ë©”ì¼</label>
                        <div class="field"><input id="ownerEmail" type="email" placeholder="name@example.com" required></div>
                    </div>
                    <div>
                        <label class="small">ìˆ˜ë ¹/ë°˜ì†¡ ì£¼ì†Œ</label>
                        <div class="field"><input id="ownerAddr" type="text" placeholder="ì‹œ/êµ¬/ë™, ìƒì„¸ ì£¼ì†Œ" required></div>
                    </div>

                    <div>
                        <label class="small">ë°˜ë ¤ë™ë¬¼ ì´ë¦„</label>
                        <div class="field"><input id="petName" type="text" placeholder="ëª¨ëª¨" required></div>
                    </div>
                    <div>
                        <label class="small">ë°˜ë ¤ë™ë¬¼ ì¢…ë¥˜</label>
                        <div class="field">
                            <select id="petType" required>
                                <option value="">ì„ íƒ</option>
                                <option value="dog">ê°œ</option>
                                <option value="cat">ê³ ì–‘ì´</option>
                                <option value="small">ì†Œë™ë¬¼</option>
                                <option value="other">ê¸°íƒ€</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="small">í’ˆì¢…</label>
                        <div class="field">
                            <select id="petBreed" required disabled>
                                <option value="">ì¢…ë¥˜ ì„ íƒ ë¨¼ì €</option>
                            </select>
                            <input id="petBreedText" type="text" placeholder="ì§ì ‘ ì…ë ¥" style="display:none;">
                        </div>
                        <small class="muted">â€» â€œê¸°íƒ€â€ ì„ íƒ ì‹œ í’ˆì¢…ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</small>
                    </div>
                    <div>
                        <label class="small">ì²´ì¤‘(kg)</label>
                        <div class="field"><input id="petWeight" type="number" min="0" step="0.1" placeholder="4.2" required></div>
                    </div>
                </div>

                <div class="grid-1" style="margin-top:8px">
                    <label class="small">ë³´ìœ  ì¤‘ì¸ í”ì (ìµœì†Œ 1ê°œ)</label>
                    <div class="slots" id="materialsBox" role="group" aria-label="ë³´ìœ  í”ì ">
                        <button type="button" class="slot" data-mat="ash">ìœ ê³¨</button>
                        <button type="button" class="slot" data-mat="hair">ëª¨ë°œ</button>
                        <button type="button" class="slot" data-mat="paw">ë°œìêµ­(í´ë ˆì´/ì‰í¬)</button>
                        <button type="button" class="slot" data-mat="item">ìœ í’ˆ(ë¦¬ë³¸/í„¸ë­‰ì¹˜ ë“±)</button>
                    </div>
                    <small class="muted">â€» ë³´ê´€ì€ ê±´ì¡°Â·ë°€ë´‰ ìƒíƒœ ê¶Œì¥. ë¶„ëŸ‰ ì•ˆë‚´ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.</small>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" disabled>ì´ì „</button>
                    <button id="next1" class="btn primary" type="button" disabled>ë‹¤ìŒ</button>
                </div>
            </section>

            <!-- STEP 2 : í’ˆëª©/ì˜µì…˜ ì„ íƒ -->
            <section class="step" id="step2">
                <div class="grid">
                    <div>
                        <label class="small">í’ˆëª©</label>
                        <div class="field">
                            <select id="product" required>
                                <option value="">ì„ íƒ</option>
                                <option value="necklace">ì£¼ì–¼ë¦¬ - ëª©ê±¸ì´(ë´‰ì…)</option>
                                <option value="ring">ì£¼ì–¼ë¦¬ - ë°˜ì§€(ë´‰ì…)</option>
                                <option value="keyring">í‚¤ë§/ì°¸(ë´‰ì…)</option>
                                <option value="resin">ë ˆì§„ ì˜¤ë¸Œì œ</option>
                                <option value="frame">í¬í† /ë°œìêµ­ ì•¡ì</option>
                                <option value="candle">ë©”ëª¨ë¦¬ ìº”ë“¤</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="small">ë©”íƒˆ/ìƒ‰ìƒ(í•´ë‹¹ ì‹œ)</label>
                        <div class="field">
                            <select id="metal">
                                <option value="">ì„ íƒ(í•´ë‹¹ ì‹œ)</option>
                                <option>ì‹¤ë²„</option>
                                <option>ìŠ¤í…Œì¸ë¦¬ìŠ¤</option>
                                <option>ê³¨ë“œí†¤</option>
                                <option>ë¡œì¦ˆê³¨ë“œí†¤</option>
                            </select>
                        </div>
                        <small class="muted">â€» ë ˆì§„/ì•¡ì/ìº”ë“¤ì€ ì„ íƒí•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</small>
                    </div>

                    <div id="chainRow" style="display:none">
                        <label class="small">ì²´ì¸ ê¸¸ì´</label>
                        <div class="field">
                            <select id="chainLength">
                                <option value="">ì„ íƒ</option>
                                <option>40cm</option><option>45cm</option><option>50cm</option>
                            </select>
                        </div>
                    </div>

                    <div id="ringRow" style="display:none">
                        <label class="small">ë°˜ì§€ í˜¸ìˆ˜</label>
                        <div class="field"><input id="ringSize" type="text" placeholder="ì˜ˆ: 12í˜¸"></div>
                    </div>

                    <div>
                        <label class="small">ìˆ˜ëŸ‰</label>
                        <div class="field"><input id="qty" type="number" min="1" step="1" value="1"></div>
                    </div>
                </div>

                <div class="grid-1" style="margin-top:10px">
                    <div>
                        <label class="small">ê°ì¸(ì„ íƒ)</label>
                        <div class="field"><input id="engrave" type="text" maxlength="20" placeholder="ì˜ˆ: MOMO 2025.08.27 (20ì ì´ë‚´)"></div>
                    </div>
                    <div>
                        <label class="small">ê°ì¸ í°íŠ¸</label>
                        <div class="field">
                            <select id="font">
                                <option value="">ì„ íƒ(ì„ íƒ ì‹œ)</option>
                                <option>Classic</option><option>Sans</option><option>Script</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="small">ê¸°íƒ€ ì˜µì…˜/ì„¤ëª…(ì„ íƒ)</label>
                        <div class="field" style="align-items:start">
                            <textarea id="optMemo" rows="3" maxlength="300" placeholder="ì˜ˆ: ìœ ê³¨Â·ëª¨ë°œ ë¹„ìœ¨, ë ˆì§„ ìƒ‰ìƒ í†¤ ë“±"></textarea>
                        </div>
                        <div class="count"><span id="optCount">0</span>/300</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev2">ì´ì „</button>
                    <button id="next2" class="btn primary" type="button" disabled>ë‹¤ìŒ</button>
                </div>
            </section>

            <!-- STEP 3 : ìˆ˜ê±°/ë°°ì†¡ & ì™„ë£Œ í¬ë§ì¼ -->
            <section class="step" id="step3">
                <div class="grid">
                    <div>
                        <label class="small">ì¬ë£Œ ì „ë‹¬ ë°©ì‹</label>
                        <div class="field">
                            <select id="shipMethod" required>
                                <option value="">ì„ íƒ</option>
                                <option value="kit">ìˆ˜ê±°í‚¤íŠ¸ ì‹ ì²­(íƒë°° ìˆ˜ê±°)</option>
                                <option value="visit">ì§ì ‘ ë°©ë¬¸</option>
                                <option value="post">ìê°€ ë°œì†¡(ìš°í¸/íƒë°°)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="small">ì™„ì„± í¬ë§ì¼</label>
                        <div class="field"><input id="targetDate" type="date" required></div>
                        <small class="note">ì¼ë°˜ ì œì‘ì€ ìµœì†Œ +7ì¼ ì´í›„ ë‚ ì§œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</small>
                    </div>

                    <div>
                        <label class="small">ìµìŠ¤í”„ë ˆìŠ¤(ì„ íƒ)</label>
                        <div class="field" style="gap:10px">
                            <input id="express" type="checkbox">
                            <span class="muted">ë¹ ë¥¸ ì œì‘ ìš”ì²­(ê°€ëŠ¥ ì¼ì • í™•ì¸ í›„ ì•ˆë‚´)</span>
                        </div>
                    </div>
                </div>

                <!-- ë°©ì‹ë³„ ì¶”ê°€ ì…ë ¥ -->
                <div class="grid" id="kitBox" style="display:none; margin-top:4px">
                    <div>
                        <label class="small">ìˆ˜ê±° ì£¼ì†Œ</label>
                        <div class="field"><input id="kitAddr" type="text" placeholder="ë„ë¡œëª…, ê±´ë¬¼ëª… ë“± ìƒì„¸ ì£¼ì†Œ"></div>
                    </div>
                    <div>
                        <label class="small">ìˆ˜ê±° í¬ë§ì¼</label>
                        <div class="field"><input id="kitDate" type="date"></div>
                    </div>
                    <div style="grid-column:1/-1">
                        <label class="small">ìˆ˜ê±° ì‹œê°„ëŒ€</label>
                        <div class="seg">
                            <button class="seg-btn is-active" type="button" data-seg="am">ì˜¤ì „</button>
                            <button class="seg-btn" type="button" data-seg="pm">ì˜¤í›„</button>
                        </div>
                        <div id="timeSlots" class="slots" role="listbox" aria-label="ìˆ˜ê±° ì‹œê°„ ì„ íƒ"></div>
                    </div>
                </div>

                <div class="grid" id="visitBox" style="display:none; margin-top:4px">
                    <div>
                        <label class="small">ë°©ë¬¸ í¬ë§ì¼</label>
                        <div class="field"><input id="visitDate" type="date"></div>
                    </div>
                    <div>
                        <label class="small">ë°©ë¬¸ ì‹œê°„</label>
                        <div class="field"><input id="visitTime" type="time"></div>
                    </div>
                </div>

                <div class="grid" id="postBox" style="display:none; margin-top:4px">
                    <div style="grid-column:1/-1">
                        <label class="small">ë°œì†¡ ì˜ˆì • íƒë°°ì‚¬/ìš´ì†¡ì¥(ì„ íƒ)</label>
                        <div class="field"><input id="tracking" type="text" placeholder="ì˜ˆ: OOíƒë°° 1234-5678-9012"></div>
                    </div>
                </div>

                <div class="grid-1" style="margin-top:10px">
                    <div>
                        <label class="small">ìš”ì²­ì‚¬í•­(ì„ íƒ)</label>
                        <div class="field" style="align-items:start">
                            <textarea id="memo" rows="4" maxlength="300" placeholder="ì œì‘ ì‹œ ìœ ì˜ì , ë¹„ìœ¨, í¬ì¥ ë“±"></textarea>
                        </div>
                        <div class="count"><span id="memoCount">0</span>/300</div>
                    </div>
                    <label class="field" style="gap:10px">
                        <input type="checkbox" id="consent" />
                        <span>ì œì‘ ê³¼ì •ìƒ ìƒ‰Â·ì…ìÂ·ê¸°í¬ ë“± ë¯¸ì„¸ ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒì„ ì´í•´í•˜ë©°, ë‚¨ì€ í”ì ì˜ ë³´ê´€/ë°˜ì†¡ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
                    </label>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev3">ì´ì „</button>
                    <button id="next3" class="btn primary" type="button" disabled>ë‹¤ìŒ</button>
                </div>
            </section>

            <!-- STEP 4 : í™•ì¸/ì™„ë£Œ -->
            <section class="step" id="step4">
                <div class="grid-1">
                    <div class="field" style="justify-content:center">
                        <strong>ì…ë ¥í•œ ì˜ˆì•½ ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</strong>
                    </div>
                    <div class="summary" id="summary"></div>
                    <label class="field" style="gap:10px">
                        <input type="checkbox" id="confirmChk" />
                        <span>ì…ë ¥í•œ ë‚´ìš©ì´ ì •í™•í•©ë‹ˆë‹¤.</span>
                    </label>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev4">ì´ì „</button>
                    <button class="btn primary" type="button" id="submitBtn" disabled>ì œì¶œí•˜ê¸°</button>
                </div>
            </section>
        </div>
    </div>
</main>

<!-- í‘¸í„°(ë©”ì¸ê³¼ ë™ì¼) -->
<footer>
    ëŒ€ì¶© ì—°ë½ì²˜ / GitHub ì£¼ì†Œ / ì´ë©”ì¼ ë“± ì…ë ¥ ì˜ˆì •/ í‘¸í„° ë†’ì´ëŠ” í—¤ë” ë°°ë„ˆ ë°˜ì‘ í…ŒìŠ¤íŠ¸ìš©.
</footer>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸: í—¤ë” ìˆ¨ê¹€ -->
<script>
    (function () {
      const header = document.querySelector('header');
      window.addEventListener('scroll', () => {
        header.style.top = (window.scrollY > 200) ? '-120px' : '0';
      });
    })();
</script>

<!-- ì˜ˆì•½ í¼ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    const $Â  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // [ìˆ˜ì •] 2. ST ê°ì²´ ì´ˆê¸°í™” ë¡œì§ ìˆ˜ì •
    // window.initialST (ìˆ˜ì • ëª¨ë“œ ë°ì´í„°)ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•˜ê³ ,
    // ì—†ìœ¼ë©´ (ì‹ ê·œ ì˜ˆì•½ ëª¨ë“œ) ê¸°ì¡´ì˜ ë¹ˆ ê°ì²´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const ST = window.initialST || {
        // step1
        ownerName:"", ownerPhone:"", ownerEmail:"", ownerAddr:"",
        petName:"", petType:"", petBreed:"", petWeight:"",
        materials: [],

        // step2
        product:"", metalColor:"", chainLength:"", ringSize:"", quantity:1,
        engravingText:"", engravingFont:"", optionsMemo:"",

        // step3
        shipMethod:"", targetDate:"", isExpress:false,
        kitAddr:"", kitDate:"", kitTime:"",
        visitDate:"", visitTime:"", trackingInfo:"",
        memo:""
    };

    // í’ˆì¢… ë°ì´í„°
    const BREEDS = {
      dog: ["ë§í‹°ì¦ˆ","í‘¸ë“¤","ì‹œë°”","ë¦¬íŠ¸ë¦¬ë²„","í¬ë©”ë¼ë‹ˆì•ˆ","ë¯¹ìŠ¤"],
      cat: ["ì½”ë¦¬ì•ˆìˆí—¤ì–´","í˜ë¥´ì‹œì•ˆ","ëŸ¬ì‹œì•ˆë¸”ë£¨","ë¨¼ì¹˜í‚¨","ë™ëŒ","ë¯¹ìŠ¤"],
      small: ["í–„ìŠ¤í„°","í† ë¼","ê¸°ë‹ˆí”¼ê·¸","íŒ¨ëŸ¿","ì•µë¬´ìƒˆ"]
    };

    // ë‚ ì§œ ì œí•œ
    (function setLimits(){
      const t=new Date();
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
      const today = `${y}-${m}-${d}`;
      const minTarget = new Date(t); minTarget.setDate(minTarget.getDate()+7);
      const y2=minTarget.getFullYear(), m2=String(minTarget.getMonth()+1).padStart(2,'0'), d2=String(minTarget.getDate()).padStart(2,'0');

      $('#targetDate').min = `${y2}-${m2}-${d2}`;
      $('#kitDate').min = today;
      $('#visitDate').min = today;
    })();

    // STEP ì´ë™
    function gotoStep(n){
      $$('.step').forEach((el,i)=> el.classList.toggle('active', i===n-1));
      $$('.step-dot').forEach((d,i)=> d.classList.toggle('active', i<=n-1));
      window.scrollTo({top:0, behavior:'smooth'});
      if(n===4) renderSummary();
    }

    // ì¢…ë¥˜/í’ˆì¢… ì²˜ë¦¬
    const petTypeEl = $('#petType');
    const petBreedSel = $('#petBreed');
    const petBreedText = $('#petBreedText');

    petTypeEl.addEventListener('change', () => {
      const type = petTypeEl.value;
      ST.petType = type;
      if(!type){
        petBreedSel.innerHTML = '<option value="">ì¢…ë¥˜ ì„ íƒ ë¨¼ì €</option>';
        petBreedSel.disabled = true;
        petBreedText.style.display='none';
        petBreedText.value='';
        v1(); return;
      }
      if(type === 'other'){
        petBreedSel.disabled = true;
        petBreedSel.innerHTML = '<option value="">ì§ì ‘ ì…ë ¥</option>';
        petBreedText.style.display='block';
        ST.petBreed = petBreedText.value.trim();
      }else{
        petBreedSel.disabled = false;
        petBreedText.style.display='none';
        petBreedText.value='';
        petBreedSel.innerHTML = '<option value="">í’ˆì¢… ì„ íƒ</option>' + (BREEDS[type]||[]).map(b=>`<option>${b}</option>`).join('');
        ST.petBreed = '';
      }
      v1();
    });

    petBreedSel.addEventListener('change', () => { ST.petBreed = petBreedSel.value; v1(); });
    petBreedText.addEventListener('input', () => { ST.petBreed = petBreedText.value.trim(); v1(); });

    // ë³´ìœ  í”ì  í† ê¸€
    $$('#materialsBox .slot').forEach(b=>{
      b.addEventListener('click', ()=>{
        const v=b.dataset.mat;
        if(b.classList.toggle('active')){
          if(!ST.materials.includes(v)) ST.materials.push(v);
        }else{
          ST.materials = ST.materials.filter(x=>x!==v);
        }
        v1();
      });
    });

    // STEP1 ê²€ì¦ (ì´ ë¡œì§ì€ ì›ë˜ ë¬¸ì œê°€ ì—†ì—ˆìŠµë‹ˆë‹¤)
    function v1(){
      const name = $('#ownerName').value.trim();
      const phone = $('#ownerPhone').value.replace(/\D/g,'');
      const email = $('#ownerEmail').value.trim();
      const addr  = $('#ownerAddr').value.trim();
      const pnm   = $('#petName').value.trim();
      const pwt   = $('#petWeight').value.trim();

      ST.ownerName=name; ST.ownerPhone=phone; ST.ownerEmail=email; ST.ownerAddr=addr;
      ST.petName=pnm; ST.petWeight=pwt;

      const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      const breedOK = (ST.petType==='other') ? !!ST.petBreed : (!!ST.petType && !!ST.petBreed);
      const matOK   = ST.materials.length > 0;

      const ok = name && phone.length>=10 && emailOK && addr && pnm && breedOK && Number(pwt)>=0 && matOK;
      $('#next1').disabled = !ok;
    }
    $$('#step1 input, #step1 select').forEach(el=> el.addEventListener('input', v1));
    v1();
    $('#next1').addEventListener('click', ()=> gotoStep(2));

    // STEP2: í’ˆëª©ì— ë”°ë¥¸ ì˜µì…˜ í‘œì‹œ
    const productEl = $('#product');
    const chainRow = $('#chainRow');
    const ringRow  = $('#ringRow');

    productEl.addEventListener('change', ()=>{
      ST.product = productEl.value;
      chainRow.style.display = (ST.product==='necklace') ? '' : 'none';
      ringRow.style.display  = (ST.product==='ring') ? '' : 'none';
      v2();
    });

    // ğŸ¯ [ìˆ˜ì •] DTO í•„ë“œëª…ê³¼ ì¼ì¹˜ì‹œì¼°ìŠµë‹ˆë‹¤.
    $('#metal').addEventListener('change', e=>{ ST.metalColor=e.target.value; v2(); });
    $('#chainLength').addEventListener('change', e=>{ ST.chainLength=e.target.value; v2(); });
    $('#ringSize').addEventListener('input', e=>{ ST.ringSize=e.target.value.trim(); v2(); });
    $('#qty').addEventListener('input', e=>{ ST.quantity = Math.max(1, parseInt(e.target.value||'1',10)); v2(); });
    $('#engrave').addEventListener('input', e=>{ ST.engravingText=e.target.value; v2(); });
    $('#font').addEventListener('change', e=>{ ST.engravingFont=e.target.value; v2(); });
    $('#optMemo').addEventListener('input', e=>{ ST.optionsMemo=e.target.value; $('#optCount').textContent = e.target.value.length; });

    function v2(){
      //  ST.quantityë¡œ ê²€ì‚¬
      let ok = !!ST.product && (+ST.quantity>=1);

      // ì„¸ë¶€ ì˜µì…˜ í•„ìˆ˜ ì¡°ê±´
      if(ST.product==='necklace'){ ok = ok && !!ST.chainLength; }
      if(ST.product==='ring'){ ok = ok && !!ST.ringSize; }

      $('#next2').disabled = !ok;
    }
    $('#prev2').addEventListener('click', ()=> gotoStep(1));
    $('#next2').addEventListener('click', ()=> gotoStep(3));

    // STEP3: ìˆ˜ê±°/ë°°ì†¡/ë‚ ì§œ
    const AM = ["09:00","09:30","10:00","10:30","11:00","11:30"];
    const PM = ["13:00","13:30","14:00","14:30","15:00","15:30","16:00"];
    let currentSeg='am', selectedBtn=null;

    function buildSlots(){
      const list = currentSeg==='am' ? AM : PM;
      const box = $('#timeSlots'); box.innerHTML='';

      //  DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
      selectedBtn=null; ST.kitTime='';
      list.forEach(t=>{
        const b=document.createElement('button');
        b.type='button'; b.className='slot'; b.textContent=t; b.dataset.value=t;
        b.addEventListener('click', ()=>{
          selectedBtn?.classList.remove('active');
          b.classList.add('active'); selectedBtn=b;
          // ğŸ¯ [ìˆ˜ì •] DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
          ST.kitTime=t; v3();
        });
        box.appendChild(b);
      });
    }
    buildSlots();
    $$('.seg-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        $('.seg-btn.is-active')?.classList.remove('is-active');
        b.classList.add('is-active');
        currentSeg=b.dataset.seg; buildSlots();
      });
    });

    // ë°©ì‹ ìŠ¤ìœ„ì¹˜
    $('#shipMethod').addEventListener('change', e=>{
      ST.shipMethod = e.target.value;
      $('#kitBox').style.display   = ST.shipMethod==='kit' ? 'grid':'none';
      $('#visitBox').style.display = ST.shipMethod==='visit' ? 'grid':'none';
      $('#postBox').style.display  = ST.shipMethod==='post' ? 'grid':'none';
      v3();
    });

    // íƒ€ê¹ƒ ë‚ ì§œ/ìµìŠ¤í”„ë ˆìŠ¤
    $('#targetDate').addEventListener('change', e=>{ ST.targetDate=e.target.value; v3(); });
    $('#express').addEventListener('change', e=>{
      // DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
      ST.isExpress=e.target.checked;

      // DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
      const t=new Date(), add=ST.isExpress?3:7; t.setDate(t.getDate()+add);
      const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
      $('#targetDate').min = `${y}-${m}-${d}`;
      if(ST.targetDate && ST.targetDate < $('#targetDate').min){ ST.targetDate=''; $('#targetDate').value=''; }
      v3();
    });

    // ë°©ì‹ë³„ í•„ë“œ
    $('#kitAddr').addEventListener('input', e=>{ ST.kitAddr=e.target.value.trim(); v3(); });
    $('#kitDate').addEventListener('change', e=>{ ST.kitDate=e.target.value; v3(); });

    $('#visitDate').addEventListener('change', e=>{ ST.visitDate=e.target.value; v3(); });
    $('#visitTime').addEventListener('change', e=>{ ST.visitTime=e.target.value; v3(); });

    // DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
    $('#tracking').addEventListener('input', e=>{ ST.trackingInfo=e.target.value.trim(); });

    $('#memo').addEventListener('input', e=>{ ST.memo=e.target.value; $('#memoCount').textContent = e.target.value.length; });

    $('#consent').addEventListener('change', v3);

    function v3(){
      let ok = !!ST.shipMethod && !!ST.targetDate && $('#consent').checked;

      if(ST.shipMethod==='kit'){
        // DTO í•„ë“œëª…ê³¼ ì¼ì¹˜
        ok = ok && !!ST.kitAddr && !!ST.kitDate && !!ST.kitTime;
      }
      if(ST.shipMethod==='visit'){
        ok = ok && !!ST.visitDate && !!ST.visitTime;
      }
      $('#next3').disabled = !ok;
    }

    $('#prev3').addEventListener('click', ()=> gotoStep(2));
    $('#next3').addEventListener('click', ()=> gotoStep(4));

    // ìš”ì•½ & ì œì¶œ
    function renderSummary(){
      const matMap = {ash:'ìœ ê³¨', hair:'ëª¨ë°œ', paw:'ë°œìêµ­', item:'ìœ í’ˆ'};
      const mats = ST.materials.map(m=>matMap[m]||m).join(', ');

      // DTO í•„ë“œëª…ê³¼ ëª¨ë‘ ì¼ì¹˜ì‹œì¼°ìŠµë‹ˆë‹¤.
      const lines = [
        `<div><strong>ì‹ ì²­ì</strong> : ${ST.ownerName} / ${ST.ownerPhone} / ${ST.ownerEmail}</div>`,
        `<div><strong>ìˆ˜ë ¹/ë°˜ì†¡ ì£¼ì†Œ</strong> : ${ST.ownerAddr}</div>`,
        `<div><strong>ë°˜ë ¤ë™ë¬¼</strong> : ${ST.petName} (${ST.petType||'-'} / ${ST.petBreed||'-'}, ${ST.petWeight}kg)</div>`,
        `<div><strong>ë³´ìœ  í”ì </strong> : ${mats||'-'}</div>`,
        `<hr style="border:none;border-top:1px solid #eee;margin:10px 0">`,
        `<div><strong>í’ˆëª©</strong> : ${ST.product}</div>`,
        `<div><strong>ë©”íƒˆ/ìƒ‰ìƒ</strong> : ${ST.metalColor||'-'}</div>`,
        (ST.product==='necklace') ? `<div><strong>ì²´ì¸ ê¸¸ì´</strong> : ${ST.chainLength}</div>` : '',
        (ST.product==='ring')     ? `<div><strong>ë°˜ì§€ í˜¸ìˆ˜</strong> : ${ST.ringSize}</div>`   : '',
        `<div><strong>ìˆ˜ëŸ‰</strong> : ${ST.quantity}</div>`,
        `<div><strong>ê°ì¸</strong> : ${ST.engravingText||'-'} ${ST.engravingFont?`(í°íŠ¸: ${ST.engravingFont})`:''}</div>`,
        ST.optionsMemo ? `<div><strong>ì˜µì…˜ ì„¤ëª…</strong> : ${ST.optionsMemo.replace(/\n/g,'<br>')}</div>` : '',
        `<hr style="border:none;border-top:1px solid #eee;margin:10px 0">`,
        `<div><strong>ì¬ë£Œ ì „ë‹¬</strong> : ${ST.shipMethod}</div>`,
        (ST.shipMethod==='kit')   ? `<div><strong>ìˆ˜ê±°</strong> : ${ST.kitAddr} / ${ST.kitDate} ${ST.kitTime||''}</div>` : '',
        (ST.shipMethod==='visit') ? `<div><strong>ë°©ë¬¸</strong> : ${ST.visitDate} ${ST.visitTime}</div>` : '',
        (ST.shipMethod==='post')  ? `<div><strong>ìê°€ ë°œì†¡</strong> : ${ST.trackingInfo||'-'}</div>` : '',
        `<div><strong>ì™„ì„± í¬ë§ì¼</strong> : ${ST.targetDate} ${ST.isExpress?'(ìµìŠ¤í”„ë ˆìŠ¤ ìš”ì²­)':''}</div>`,
        ST.memo ? `<div><strong>ìš”ì²­ì‚¬í•­</strong> : ${ST.memo.replace(/\n/g,'<br>')}</div>` : ''
      ].filter(Boolean).join('');

      $('#summary').innerHTML = lines;
    }

    $('#confirmChk').addEventListener('change', ()=> $('#submitBtn').disabled = !$('#confirmChk').checked);
    $('#prev4').addEventListener('click', ()=> gotoStep(3));

    $('#submitBtn').addEventListener('click', ()=>{

        // 3-1. ìˆ˜ì • ëª¨ë“œì¸ì§€ (IDê°€ ìˆëŠ”ì§€) í™•ì¸
        const isUpdate = !!window.RESERVATION_ID;

        // 3-2. ëª¨ë“œì— ë”°ë¼ URL ë¶„ê¸°
        const url = isUpdate ? `/goods/update/${window.RESERVATION_ID}` : '/reserve/save';
        const method = 'POST'; // HTTP ë©”ì„œë“œëŠ” POSTë¡œ ë™ì¼í•˜ê²Œ ì‚¬ìš©

        // fetchë¡œ ì „ì†¡
        fetch(url, {
            method: method,
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(ST) // ST ê°ì²´ ì „ì†¡
        })
            .then(response => {
                if (response.ok) {
                    // 3-3. ëª¨ë“œì— ë”°ë¼ ì„±ê³µ ë©”ì‹œì§€ ë¶„ê¸°
                    alert(isUpdate ? 'ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/mypage'; // ë§ˆì´í˜ì´ì§€ë¡œ ë³µê·€
                } else {
                    alert(isUpdate ? 'ì˜ˆì•½ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'ì˜ˆì•½ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    });

    // [ì¶”ê°€] 4. ìˆ˜ì • ëª¨ë“œì¼ ë•Œ í¼ì— ê¸°ì¡´ ë°ì´í„°ë¥¼ ì±„ì›Œë„£ëŠ” í•¨ìˆ˜
    function populateFormFromST() {
        if (!window.initialST) return; // ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì‹¤í–‰ ì•ˆ í•¨

        // Step 1
        $('#ownerName').value = ST.ownerName;
        $('#ownerPhone').value = ST.ownerPhone;
        $('#ownerEmail').value = ST.ownerEmail;
        $('#ownerAddr').value = ST.ownerAddr;
        $('#petName').value = ST.petName;
        $('#petType').value = ST.petType;
        petTypeEl.dispatchEvent(new Event('change')); // í’ˆì¢… selectbox ê°±ì‹ 
        if (ST.petType === 'other') {
            $('#petBreedText').value = ST.petBreed;
        } else {
            $('#petBreed').value = ST.petBreed;
        }
        $('#petWeight').value = ST.petWeight;
        ST.materials.forEach(mat => {
            $(`#materialsBox .slot[data-mat="${mat}"]`)?.classList.add('active');
        });

        // Step 2
        $('#product').value = ST.product;
        productEl.dispatchEvent(new Event('change')); // ì˜µì…˜ ê°±ì‹ 
        $('#metal').value = ST.metalColor;
        $('#chainLength').value = ST.chainLength;
        $('#ringSize').value = ST.ringSize;
        $('#qty').value = ST.quantity;
        $('#engrave').value = ST.engravingText;
        $('#font').value = ST.engravingFont;
        $('#optMemo').value = ST.optionsMemo;

        // Step 3
        $('#shipMethod').value = ST.shipMethod;
        $('#shipMethod').dispatchEvent(new Event('change')); // ìˆ˜ê±°/ë°°ì†¡ í¼ ê°±ì‹ 
        $('#targetDate').value = ST.targetDate;
        $('#express').checked = ST.isExpress;
        $('#kitAddr').value = ST.kitAddr;
        $('#kitDate').value = ST.kitDate;
        // (kitTime, visitTime ë“± ì‹œê°„ ê´€ë ¨ í¼ë„ í•„ìš”ì‹œ ë™ì¼í•˜ê²Œ ì±„ì›Œì¤ë‹ˆë‹¤)
        $('#tracking').value = ST.trackingInfo;
        $('#memo').value = ST.memo;

        // ëª¨ë“  ê²€ì¦ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ 'ë‹¤ìŒ' ë²„íŠ¼ í™œì„±í™”
        v1(); v2(); v3();
    }

    // 5. í˜ì´ì§€ ë¡œë“œ ì‹œ í¼ ì±„ìš°ëŠ” í•¨ìˆ˜ ì‹¤í–‰
    populateFormFromST();

    // ì´ˆê¸° í¬ì»¤ìŠ¤
    $('#ownerName').focus();
</script>
</body>
</html>