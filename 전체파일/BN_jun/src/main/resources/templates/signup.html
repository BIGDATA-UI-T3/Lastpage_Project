<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <link rel="stylesheet" th:href="@{/css/signup.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <title>회원가입하기</title>

</head>

<body>

<main class="signup-bg">
    <div class="signup-wrap">
        <h2 class="signup-title">회원가입하기</h2>

        <form class="signup-form-box" th:action="@{/signup}" th:object="${registerFormDto}" method="post" autocomplete="off">

            <input type="text" th:field="*{name}" placeholder="이름" required>
            <p class="error-message" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></p>

            <input type="text" th:field="*{username}" placeholder="아이디 (8자 이상 영문/숫자)" required>
            <p class="error-message" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></p>

            <input type="password" th:field="*{password}" placeholder="비밀번호 (8~16자 영문/숫자)" required>
            <p class="error-message" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></p>

            <input type="password" th:field="*{passwordCheck}" placeholder="비밀번호 확인" required>
            <p class="error-message" th:if="${#fields.hasErrors('passwordCheck')}" th:errors="*{passwordCheck}"></p>

            <div class="signup-row email-row">
                <input type="text" th:field="*{emailId}" class="email-id" placeholder="이메일" required>
                <span class="at">@</span>
                <input type="text" th:field="*{emailDomain}" class="email-domain" placeholder="이메일 도메인" required>
                <select class="domain-select" name="emailDomainSelect">
                    <option>직접입력</option>
                    <option>naver.com</option>
                    <option>gmail.com</option>
                    <option>daum.net</option>
                </select>
                <button type="button" class="signup-btn" id="emailVerifyBtn">인증하기</button>
            </div>
            <p class="error-message" th:if="${#fields.hasErrors('emailId')}" th:errors="*{emailId}"></p>
            <p class="error-message" th:if="${#fields.hasErrors('emailDomain')}" th:errors="*{emailDomain}"></p>

            <div class="signup-row sms-row">
                <input type="text" th:field="*{smsCode}" class="sms-input" placeholder="이메일 인증 번호 입력" required>
            </div>
            <p class="error-message" th:if="${#fields.hasErrors('smsCode')}" th:errors="*{smsCode}"></p>

            <div class="signup-row birth-row">
                <input type="text" th:field="*{birthYear}" maxlength="4" placeholder="생년(4자)" required>
                <input type="text" th:field="*{birthMonth}" maxlength="2" placeholder="월" required>
                <input type="text" th:field="*{birthDay}" maxlength="2" placeholder="일" required>
            </div>

            <div class="signup-row gender-row">
                <label><input type="radio" th:field="*{gender}" value="none" required> 선택안함</label>
                <label><input type="radio" th:field="*{gender}" value="male"> 남</label>
                <label><input type="radio" th:field="*{gender}" value="female"> 여</label>
            </div>

            <div class="signup-row phone-row">
                <input type="text" th:field="*{phone}" class="phone-input" placeholder="휴대폰('-' 제외)" required>
            </div>
            <p class="error-message" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}"></p>

            <button type="submit" class="signup-btn big">회원가입하기</button>

        </form>
    </div>
</main>

<script>
    (function () {
        const header = document.querySelector('header');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 200) {
                header.style.top = '-120px';
            } else {
                header.style.top = '0';
            }
        });
    })();

    document.addEventListener("DOMContentLoaded", function () {

        const emailDomainInput = document.querySelector('.email-domain');
        const emailDomainSelect = document.querySelector('.domain-select');

        emailDomainSelect.addEventListener('change', function() {
            if (this.value === '직접입력') {
                emailDomainInput.value = '';
                emailDomainInput.readOnly = false;
                emailDomainInput.focus();
            } else {
                emailDomainInput.value = this.value;
                emailDomainInput.readOnly = true;
            }
        });

        const emailVerifyBtn = document.getElementById('emailVerifyBtn');
        emailVerifyBtn.addEventListener('click', async () => {
            const emailId = document.querySelector('input[name="emailId"]').value;
            const emailDomain = document.querySelector('input[name="emailDomain"]').value;
            if (!emailId || !emailDomain) {
                alert('이메일 주소를 모두 입력해주세요.'); return;
            }

            emailVerifyBtn.disabled = true;
            emailVerifyBtn.textContent = '발송 중...';

            const formData = new FormData();
            formData.append('emailId', emailId);
            formData.append('emailDomain', emailDomain);

            try {
                // MailApiController 호출
                const response = await fetch('/signup/send-email-code', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message); // "인증 코드가 발송되었습니다."
                    emailVerifyBtn.textContent = '재발송';
                    startTimer(180, emailVerifyBtn); // 3분 타이머
                } else {
                    // (500 오류 등 서버가 실패 응답을 준 경우)
                    alert(result.message); // "이메일 발송에 실패했습니다."
                    emailVerifyBtn.textContent = '인증하기';
                    emailVerifyBtn.disabled = false;
                }
            } catch (error) {
                // (네트워크 오류, 서버 다운 등)
                alert('인증 코드 발송 중 오류가 발생했습니다.');
                emailVerifyBtn.textContent = '인증하기';
                emailVerifyBtn.disabled = false;
            }
        });

        // 3분 타이머 함수
        function startTimer(duration, button) {
            let timer = duration, minutes, seconds;
            button.disabled = true;
            const interval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                button.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                    clearInterval(interval);
                    button.textContent = '인증하기';
                    button.disabled = false;
                }
            }, 1000);
        }
    });
</script>
</body>
</html>