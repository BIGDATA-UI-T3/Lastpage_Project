<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원정보 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/EditInfo.css}">
</head>

<body>
<div class="header-wrapper">
    <header>
        <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>

        <div class="side-menu" id="sideMenu">
            <ul>
                <li><a href="#">홈</a><ul><li><a href="#">인사말</a></li></ul></li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li><a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </div>

        <div class="logo">
            <a href="#"><img src="../Asset/LastPage로고_투명.png" alt="로고" /></a>
        </div>
        <nav>
            <ul>
                <li><a href="#">홈</a><ul><li><a href="#">인사말</a></li></ul></li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li><a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </nav>

        <div class="auth"
             th:data-login="${session.loginUser != null ? 'true' : 'false'}"
             th:data-username="${session.loginUser != null ? session.loginUser.name : ''}">
            <a href="/signin" class="login-link">로그인</a>
            <a href="/signup" class="signup-link">회원가입</a>
        </div>
    </header>

    <!-- 본문 -->
    <div class="container mt-5 mb-5">
        <h2>회원정보 수정</h2>

        <!-- userType, oauthEmail 정보를 data-* 속성으로 전달 -->
        <form id="editForm"
              th:data-usertype="${userType}"
              th:data-oauthemail="${user?.oauthEmail}">

            <div class="mb-3">
                <label class="form-label">이름</label>
                <input type="text" id="name" class="form-control" placeholder="홍길동"
                       th:value="${user?.name}">
                <div class="muted small">소셜 로그인 사용자는 이름 수정이 불가합니다.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">이메일</label>
                <div class="d-flex gap-2">
                    <input type="text" id="emailId" class="form-control" placeholder="example" style="flex:1"
                           th:value="${user?.emailId}">
                    <span class="align-self-center">@</span>
                    <input type="text" id="emailDomain" class="form-control" placeholder="gmail.com" style="flex:1"
                           th:value="${user?.emailDomain}">
                </div>
                <div class="muted small">소셜 로그인 사용자는 이메일 수정이 불가합니다.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">비밀번호</label>
                <input type="password" id="password" class="form-control" placeholder="비밀번호 변경 시 입력">
                <div id="pwStrengthBar" style="height:6px;border-radius:3px;margin-top:5px;"></div>
                <div id="pwStrengthText" style="font-size:12px;font-weight:bold;margin-top:3px;"></div>
                <div class="muted small">소셜 로그인 사용자는 비밀번호 수정이 불가합니다.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">비밀번호 확인</label>
                <input type="password" id="password-confirm" class="form-control" placeholder="비밀번호 확인">
            </div>

            <div class="mb-3">
                <label class="form-label">휴대폰 번호</label>
                <input type="tel" id="phone" class="form-control" placeholder="010-1234-5678"
                       th:value="${user?.phone_num}">
            </div>

            <div class="mb-3">
                <label class="form-label">생년월일</label>
                <input type="date" id="birth" class="form-control"
                       th:value="${user?.year != null ? user.year + '-' + #numbers.formatInteger(user.month,2) + '-' + #numbers.formatInteger(user.day,2) : ''}">
            </div>

            <div class="mb-3">
                <label class="form-label">성별</label>
                <select id="gender" class="form-select" th:value="${user?.gender}">
                    <option value="">선택</option>
                    <option value="M">남성</option>
                    <option value="F">여성</option>
                    <option value="N">선택안함</option>
                </select>
            </div>

            <button type="button" class="btn-save" id="saveBtn">저장하기</button>
        </form>
    </div>

    <footer>대충 연락처 / GitHub 주소 / 이메일 등 입력 예정</footer>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      /* ===============================
         로그인 상태 표시 (헤더 영역)
      =============================== */
      const authDiv = document.querySelector(".auth");
      if (authDiv) {
        const isLoggedIn = authDiv.dataset.login === "true";
        const username = authDiv.dataset.username;
        const loginLink = authDiv.querySelector(".login-link");
        const signupLink = authDiv.querySelector(".signup-link");

        if (isLoggedIn && loginLink && signupLink) {
          // 로그인 상태 → "누구누구님 반갑습니다"로 교체
          loginLink.textContent = `${username}님 반갑습니다.`;
          signupLink.textContent = "로그아웃";
          loginLink.href = "/mypage/Mypage";
          signupLink.href = "/logout";
        }
      }

      /* ===============================
         헤더 스크롤 애니메이션
      =============================== */
      const header = document.querySelector("header");
      if (header) {
        window.addEventListener("scroll", () => {
          header.style.top = window.scrollY > 200 ? "-120px" : "0";
        });
      }

      /* ===============================
         회원정보 수정 폼 제어
      =============================== */
      const form = document.getElementById("editForm");
      if (!form) return;

      const userType = form.dataset.usertype;
      const oauthEmail = form.dataset.oauthemail;

      const name = document.getElementById("name");
      const emailId = document.getElementById("emailId");
      const emailDomain = document.getElementById("emailDomain");
      const password = document.getElementById("password");
      const pwConfirm = document.getElementById("password-confirm");

      // 소셜 로그인 사용자의 경우 — OAuth 이메일 불러오기 + 수정 불가 처리
      if (userType === "social") {
        if (oauthEmail) {
          const [idPart, domainPart] = oauthEmail.split("@");
          if (emailId) emailId.value = idPart || "";
          if (emailDomain) emailDomain.value = domainPart || "";
        }
        [name, emailId, emailDomain, password, pwConfirm].forEach(el => el.disabled = true);
      }

      //  자체 로그인 사용자의 경우 — 모든 항목 수정 가능
      if (userType === "native") {
        [name, emailId, emailDomain, password, pwConfirm].forEach(el => el.disabled = false);
      }

      /* ===============================
         비밀번호 강도 검사 및 재사용 체크
      =============================== */
      const pwBar = document.getElementById("pwStrengthBar");
      const pwText = document.getElementById("pwStrengthText");

      if (password) {
        password.addEventListener("input", async () => {
          const val = password.value;
          const result = checkStrength(val);
          if (pwBar) pwBar.style.width = result.score * 25 + "%";
          if (pwBar) pwBar.style.backgroundColor = result.color;
          if (pwText) {
            pwText.textContent = result.text;
            pwText.style.color = result.color;
          }

          if (val.length >= 8) {
            const reuseCheck = await fetch("/mypage/EditInfo/checkPassword", {
              method: "POST",
              headers: { "Content-Type": "text/plain" },
              body: val
            });
            if (reuseCheck.ok) {
              const reused = await reuseCheck.text();
              if (reused === "reused" && pwText && pwBar) {
                pwText.textContent = "기존에 사용한 비밀번호는 사용할 수 없습니다.";
                pwText.style.color = "#ff4d4f";
                pwBar.style.backgroundColor = "#ff4d4f";
              }
            }
          }
        });
      }

      if (pwConfirm) {
        pwConfirm.addEventListener("input", () => {
          pwConfirm.style.borderColor =
            pwConfirm.value && pwConfirm.value !== password.value ? "red" : "";
        });
      }

      function checkStrength(password) {
        let score = 0;
        if (password.length >= 8) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/[0-9]/.test(password)) score++;
        if (/[^A-Za-z0-9]/.test(password)) score++;
        switch (score) {
          case 0:
          case 1:
            return { score, text: "보안 수준: 약함", color: "#ff4d4f" };
          case 2:
            return { score, text: "보안 수준: 보통", color: "#faad14" };
          case 3:
            return { score, text: "보안 수준: 좋음", color: "#52c41a" };
          case 4:
            return { score, text: "보안 수준: 매우 강함", color: "#389e0d" };
          default:
            return { score: 0, text: "비밀번호를 입력하세요", color: "#ccc" };
        }
      }

      /* ===============================
         저장 요청
      =============================== */
      const saveBtn = document.getElementById("saveBtn");
      if (saveBtn) {
        saveBtn.addEventListener("click", async () => {
          const pwVal = password.value.trim();
          const pw2Val = pwConfirm.value.trim();
          if (pwVal && pwVal !== pw2Val) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
          }

          const birthValue = document.getElementById("birth").value;
          let year = null,
            month = null,
            day = null;
          if (birthValue) {
            const date = new Date(birthValue);
            year = date.getFullYear();
            month = date.getMonth() + 1;
            day = date.getDate();
          }

          const updated = {
            name: name.value.trim(),
            emailId: emailId.value.trim(),
            emailDomain: emailDomain.value.trim(),
            password: pwVal,
            phone_num: document.getElementById("phone").value.trim(),
            year,
            month,
            day,
            gender: document.getElementById("gender").value
          };

          const res = await fetch("/mypage/EditInfo/update", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated)
          });

          if (res.ok) {
        alert("회원정보가 수정되었습니다.");

        // 새 이름을 localStorage에 저장 (백엔드 응답 대신 폼 값 사용)
        const newName = name.value.trim();
        localStorage.setItem("updatedUserName", newName);

        // 마이페이지로 이동
        window.location.href = "/mypage/Mypage";
      } else {
        const msg = await res.text();
        alert(msg);
      }
        });
      }
    });
</script>

</body>
</html>
