<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 페이지 | LastPage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/Payments.css}">

</head>
<div class="header-wrapper">
    <!-- 헤더 -->
    <header>

        <!-- 햄버거 -->
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <!-- 사이드 메뉴 -->
        <div class="side-menu" id="sideMenu">
            <ul>
                <li><a href="#">홈</a>
                    <ul>
                        <li><a href="#">인사말</a></li>
                    </ul>
                </li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li><a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </div>




        <div class="logo">
            <a href="#"><img src="../Asset/LastPage로고_투명.png" alt="로고" /></a>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="#">홈</a>
                    <ul>
                        <li><a href="#">인사말</a></li>
                    </ul>
                </li>

                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li>
                    <a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>

                <li>
                    <a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </nav>
        <div class="auth"
             th:data-login="${session.loginUser != null ? 'true' : 'false'}"
             th:data-username="${session.loginUser != null ? session.loginUser.name : ''}">
            <a href="/signin" class="login-link">로그인</a>
            <a href="/signup" class="signup-link">회원가입</a>
        </div>
    </header>
    <body>
    <div class="payment-container">
        <h3 class="text-center mb-4">결제하기</h3>

        <!--  결제 수단 버튼 (Toss 추가됨) -->
        <div class="payment-method">
            <button class="method-btn active" data-target="card">신용/체크카드</button>
            <button class="method-btn" data-target="kakao">카카오페이</button>
            <button class="method-btn" data-target="naver">네이버페이</button>
            <button class="method-btn" data-target="toss">토스페이</button>
        </div>

        <!-- 카드 결제 -->
        <div id="card" class="payment-section active">
            <div class="mb-3">
                <label class="form-label">카드번호</label>
                <input type="text" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">유효기간</label>
                    <input type="text" class="form-control" placeholder="MM/YY">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">CVC</label>
                    <input type="password" class="form-control" placeholder="3자리">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">이름 (카드 명의자)</label>
                <input type="text" class="form-control" placeholder="홍길동">
            </div>
        </div>

        <!-- 카카오페이 -->
        <div id="kakao" class="payment-section">
            <div class="text-center mt-4">
                <img src="https://developers.kakao.com/tool/resource/static/img/button/pay/payment_icon_yellow_large.png" alt="KakaoPay" width="160">
                <p class="mt-3 text-muted">카카오페이로 간편하게 결제합니다.</p>
            </div>
        </div>

        <!-- 네이버페이 -->
        <div id="naver" class="payment-section">
            <div class="text-center mt-4">
                <img src="https://ssl.pstatic.net/naverpay/resources/img/common/logo/naverpay_logo.png" alt="NaverPay" width="150">
                <p class="mt-3 text-muted">네이버페이로 간편하게 결제합니다.</p>
            </div>
        </div>

        <!--  토스페이 -->
        <div id="toss" class="payment-section">
            <div class="text-center mt-4">
                <img src="https://static.toss.im/3d/pay/toss-logo-blue.png" alt="TossPay" width="150">
                <p class="mt-3 text-muted">토스페이로 빠르고 안전하게 결제합니다.</p>
            </div>
        </div>

        <div class="mt-4">
            <h5>결제금액: <strong th:text="'₩ ' + ${amount}">₩ 10</strong></h5>
        </div>

        <button id="payBtn" class="btn-pay">결제하기</button>
    </div>

<footer>
    대충 연락처 / GitHub 주소 / 이메일 등 입력 예정/ 푸터 높이는 헤더 배너 반응 테스트용.
</footer>

<script>


 document.addEventListener("DOMContentLoaded", () => {
   /* ===== 헤더 로그인 상태 표시 ===== */
   const authDiv = document.querySelector(".auth");
   const isLoggedIn = authDiv.dataset.login === "true";
   const username = authDiv.dataset.username;
   const loginLink = authDiv.querySelector(".login-link");
   const signupLink = authDiv.querySelector(".signup-link");

   if (isLoggedIn) {
     loginLink.textContent = `${username}님 반갑습니다.`;
     signupLink.textContent = "로그아웃";
     loginLink.href = "/mypage/Mypage";
     signupLink.href = "/logout";
   }

   /* ===== 헤더 스크롤 이벤트 ===== */
   const header = document.querySelector("header");
   window.addEventListener("scroll", () => {
     header.style.top = window.scrollY > 200 ? "-120px" : "0";
   });

   /* ===== 햄버거 메뉴 ===== */
   const hamburger = document.getElementById("hamburger");
   const sideMenu = document.getElementById("sideMenu");
   hamburger.addEventListener("mouseenter", () => sideMenu.classList.add("open"));
   sideMenu.addEventListener("mouseleave", () => sideMenu.classList.remove("open"));

   /* ===== 결제 수단 선택 ===== */
   const methodButtons = document.querySelectorAll(".method-btn");
   const sections = document.querySelectorAll(".payment-section");

   methodButtons.forEach((btn) => {
     btn.addEventListener("click", () => {
       methodButtons.forEach((b) => b.classList.remove("active"));
       sections.forEach((sec) => sec.classList.remove("active"));
       btn.classList.add("active");
       document.getElementById(btn.dataset.target).classList.add("active");
     });
   });

   /* ===== 결제 버튼 클릭 ===== */
   document.getElementById("payBtn").addEventListener("click", async () => {
     try {
       const activeMethod = document.querySelector(".method-btn.active").dataset.target;
       const amount = 35000; // th:text 바인딩 or JS 변수로 전달 가능
       const orderId = "ORDER_" + Date.now();

       // 백엔드로 결제 요청
       const res = await fetch("/api/payments/create", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({
           method: activeMethod.toUpperCase(), // CARD / KAKAO / NAVER
           amount,
           orderId
         })
       });

       if (!res.ok) {
         alert(await res.text());
         return;
       }

       const data = await res.json();

       // 결제 수단별 후속 처리
       switch (activeMethod) {
         case "card":
           alert("카드 결제가 완료되었습니다.");
           window.location.href = "/pay/success";
           break;

         case "kakao":
           if (data.next_redirect_pc_url) {
             window.location.href = data.next_redirect_pc_url;
           } else {
             alert("카카오페이 결제창 연결 실패");
           }
           break;

         case "naver":
           if (data.redirect_url) {
             window.location.href = data.redirect_url;
           } else {
             alert("네이버페이 결제창 연결 실패");
           }
           break;

         default:
           alert("지원하지 않는 결제 방식입니다.");
       }
     } catch (err) {
       console.error("결제 중 오류:", err);
       alert("결제 요청 중 오류가 발생했습니다.");
     }
   });
 });


</script>

</body>
</html>
