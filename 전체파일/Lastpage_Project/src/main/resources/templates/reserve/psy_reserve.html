<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/psy_reserve.css}">
    <title>심리상담 예약</title>
</head>
<body th:data-mode="${mode}" th:data-id="${reserve != null ? reserve.id : ''}">
<div class="header-wrapper">
    <header>
        <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>

        <div class="side-menu" id="sideMenu">
            <ul>
                <li><a href="#">홈</a><ul><li><a href="#">인사말</a></li></ul></li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li><a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </div>

        <div class="logo">
            <a href="#"><img src="../Asset/LastPage로고_투명.png" alt="로고" /></a>
        </div>
        <nav>
            <ul>
                <li><a href="#">홈</a><ul><li><a href="#">인사말</a></li></ul></li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li><a href="#">커뮤니티</a></li>
                <li><a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </nav>
        <div class="auth">
            <a href="#">로그인</a>
            <a href="#">회원가입</a>
        </div>
    </header>

    <!-- 메인 -->
    <div class="wrap">
        <div class="card">
            <div class="steps" aria-label="예약 단계">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
                <div class="step-dot" id="dot4"></div>
            </div>
            <h1 class="title" id="formTitle"
                th:text="${mode == 'edit' ? '심리상담 예약 수정' : '심리상담 예약'}">심리상담 예약</h1>

            <!-- STEP 1 -->
            <section class="step active" id="step1">
                <div class="grid">
                    <div>
                        <label class="small">예약자명</label>
                        <div class="field">
                            <input id="name" type="text" placeholder="홍길동"
                                   th:value="${reserve != null ? reserve.name : ''}" required>
                        </div>
                    </div>
                    <div>
                        <label class="small">생년월일</label>
                        <div class="field">
                            <input id="birth" type="date" th:value="${reserve != null ? reserve.birth : ''}" required>
                        </div>
                    </div>
                    <div>
                        <label class="small">성별</label>
                        <div class="field">
                            <select id="gender" required>
                                <option value="">선택</option>
                                <option value="F" th:selected="${reserve != null and reserve.gender == 'F'}">여</option>
                                <option value="M" th:selected="${reserve != null and reserve.gender == 'M'}">남</option>
                                <option value="N" th:selected="${reserve != null and reserve.gender == 'N'}">선택안함</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="small">휴대폰번호</label>
                        <div class="field">
                            <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678"
                                   th:value="${reserve != null ? reserve.phone : ''}" required>
                        </div>
                    </div>
                    <div>
                        <label class="small">이메일</label>
                        <div class="field">
                            <input id="email" type="email" placeholder="name@example.com"
                                   th:value="${reserve != null ? reserve.email : ''}" required>
                        </div>
                    </div>
                    <div>
                        <label class="small">집주소</label>
                        <div class="field">
                            <input id="address" type="text" placeholder="시/구/동, 상세 주소"
                                   th:value="${reserve != null ? reserve.address : ''}" required>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <button id="next1" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 2 -->
            <section class="step" id="step2">
                <div class="grid">
                    <div>
                        <label class="small">상담 날짜</label>
                        <div class="field">
                            <input id="consultDate" type="date"
                                   th:value="${reserve != null ? reserve.consultDate : ''}" required>
                        </div>
                    </div>
                    <div>
                        <label class="small">상담사</label>
                        <div class="field">
                            <select id="counselor" required>
                                <option value="">상담사 선택</option>
                                <option value="손보금" th:selected="${reserve != null and reserve.counselor == '손보금'}">손보금 상담사</option>
                                <option value="박준형" th:selected="${reserve != null and reserve.counselor == '박준형'}">박준형 상담사</option>
                                <option value="심예진" th:selected="${reserve != null and reserve.counselor == '심예진'}">심예진 상담사</option>
                                <option value="보동이" th:selected="${reserve != null and reserve.counselor == '보동이'}">보동이 상담사</option>
                                <option value="금동이" th:selected="${reserve != null and reserve.counselor == '금동이'}">금동이 상담사</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid-1" style="margin-top:10px">
                    <div>
                        <label class="small">상담 시간 (1시간)</label>
                        <div id="timeSlots" class="slots" role="listbox" aria-label="상담 시간 선택"
                             th:data-time="${reserve != null ? reserve.time : ''}"></div>
                    </div>

                    <div>
                        <label class="small">메모 (선택)</label>
                        <div class="field" style="align-items:start">
                            <textarea id="memo" rows="4" maxlength="300"
                                      th:text="${reserve != null ? reserve.memo : ''}"
                                      placeholder="본인의 심리상태를 자세하게 적어주시면 상담시 도움이됩니다."></textarea>
                        </div>
                        <div class="count"><span id="memoCount">0</span>/300</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev2">이전</button>
                    <button id="next2" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 3 -->
            <section class="step" id="step3">
                <div class="grid-1">
                    <div class="field" style="justify-content:center"><strong>입력한 예약 내용을 확인해 주세요.</strong></div>
                    <div class="summary" id="summary"></div>
                    <label class="field" style="gap:10px">
                        <input type="checkbox" id="confirmChk" style="margin:0 0;" />
                        <span>입력한 내용이 정확합니다.</span>
                    </label>
                </div>
                <div class="actions">
                    <button class="btn secondary" type="button" id="prev3">이전</button>
                    <button id="next3" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 4 -->
            <section class="step" id="step4">
                <div class="grid-1">
                    <div class="field" style="justify-content:center">
                        <strong id="finalTitle"
                                th:text="${mode == 'edit' ? '예약 수정이 완료되었습니다.' : '예약 요청이 완료되었습니다.'}">
                            예약 요청이 완료되었습니다.
                        </strong>
                    </div>
                    <div class="summary" id="finalSummary"></div>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev4">이전</button>
                    <button class="btn submit-btn" id="submitBtn" type="button">제출하기</button>
                </div>
            </section>
        </div>
    </div>
    <footer>대충 연락처 / GitHub 주소 / 이메일 등 입력 예정</footer>
</div>

<script>
    const state = {
     name: "", birth: "", gender: "", phone: "", email: "", address: "",
     consultDate: "", time: "", counselor: "", memo: ""
   };

   const qs = s => document.querySelector(s);
   const qsa = s => [...document.querySelectorAll(s)];

   //url 파라미터로 id 추출
   const params = new URLSearchParams(window.location.search);
   const reserveId = params.get("id");
   if (reserveId) state.id = reserveId;

   // 수정모드로 들어갔을 때 데이터 불러와야 함
   if (state.id) {
       document.getElementById("formTitle").textContent = "심리상담 예약 수정";
       document.getElementById("finalTitle").textContent = "예약 수정이 완료되었습니다.";
       fetch(`/api/psy_reserve/${state.id}`)
           .then(res => res.json())
           .then(data => {
               Object.assign(state, data);
               fillForm(data);
           })
           .catch(err => console.error("예약 정보 불러오기 실패:", err));
   }

   const goto = (n) => {
     qsa('.step').forEach((el, i) => el.classList.toggle('active', i === n - 1));
     qsa('.step-dot').forEach((d, i) => d.classList.toggle('active', i <= n - 1));
     window.scrollTo({ top: 0, behavior: 'smooth' });
     if (n === 3) renderSummary();
     if (n === 4) renderFinal();
   };

   (function setDateLimits() {
     const today = new Date();
     qs('#birth').max = today.toISOString().slice(0, 10);
     qs('#consultDate').min = today.toISOString().slice(0, 10);
   })();

   const requireFilled = () => {
     const name = qs('#name').value.trim();
     const birth = qs('#birth').value;
     const gender = qs('#gender').value;
     const phone = qs('#phone').value.replace(/\D/g, '');
     const email = qs('#email').value.trim();
     const address = qs('#address').value.trim();
     const validEmail = !!email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
     const validPhone = phone.length >= 10;
     const all = name && birth && gender && validPhone && validEmail && address;
     qs('#next1').disabled = !all;

     if (all) {
       Object.assign(state, { name, birth, gender, phone, email, address });
     }
   };

   qsa('#step1 input, #step1 select').forEach(el => el.addEventListener('input', requireFilled));
   requireFilled();

   qs('#next1').addEventListener('click', () => goto(2));

   const timeWrap = qs('#timeSlots');
   let selectedBtn = null;

   (function buildSlots() {
     for (let h = 10; h <= 18; h++) {
       const from = String(h).padStart(2, '0') + ':00';
       const to = String(h + 1).padStart(2, '0') + ':00';
       const b = document.createElement('button');
       b.type = 'button';
       b.className = 'slot';
       b.textContent = `${from} - ${to}`;
       b.dataset.value = `${from}-${to}`;
       b.addEventListener('click', () => {
         if (selectedBtn) selectedBtn.classList.remove('active');
         b.classList.add('active');
         selectedBtn = b;
         state.time = b.dataset.value;
         validateStep2();
       });
       timeWrap.appendChild(b);
     }
   })();

   const memoEl = qs('#memo');
   const memoCount = qs('#memoCount');
   memoEl.addEventListener('input', () => {
     memoCount.textContent = memoEl.value.length;
     state.memo = memoEl.value;
   });

   const validateStep2 = () => {
     const date = qs('#consultDate').value;
     const counselor = qs('#counselor').value;
     const ok = !!date && !!state.time && !!counselor;
     qs('#next2').disabled = !ok;
     if (ok) {
       Object.assign(state, { consultDate: date, counselor });
     }
   };

   qsa('#consultDate, #counselor').forEach(el => el.addEventListener('input', validateStep2));
   qs('#prev2').addEventListener('click', () => goto(1));
   qs('#next2').addEventListener('click', () => goto(3));

   function renderSummary() {
     const s = qs('#summary');
     s.innerHTML = `
       <div><strong>예약자명</strong> : ${state.name}</div>
       <div><strong>생년월일</strong> : ${state.birth}</div>
       <div><strong>성별</strong> : ${state.gender}</div>
       <div><strong>휴대폰</strong> : ${state.phone}</div>
       <div><strong>이메일</strong> : ${state.email}</div>
       <div><strong>주소</strong> : ${state.address}</div>
       <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
       <div><strong>상담 날짜</strong> : ${state.consultDate}</div>
       <div><strong>상담 시간</strong> : ${state.time}</div>
       <div><strong>상담사</strong> : ${state.counselor}</div>
       <div><strong>메모</strong> : ${state.memo ? state.memo.replace(/\n/g, '<br>') : '-'}</div>
     `;
   }

   function fillForm(data) {
       qs('#name').value = data.name || "";
       qs('#birth').value = data.birth || "";
       qs('#gender').value = data.gender || "";
       qs('#phone').value = data.phone || "";
       qs('#email').value = data.email || "";
       qs('#address').value = data.address || "";
       qs('#consultDate').value = data.consultDate || "";
       qs('#counselor').value = data.counselor || "";
       qs('#memo').value = data.memo || "";
       if (data.time) {
           const btn = [...document.querySelectorAll('.slot')]
               .find(b => b.dataset.value === data.time);
           if (btn) {
               btn.classList.add('active');
               selectedBtn = btn;
           }
       }
       requireFilled();
       validateStep2();
   }

   const chk = qs('#confirmChk');
   chk.addEventListener('change', () => qs('#next3').disabled = !chk.checked);
   qs('#prev3').addEventListener('click', () => goto(2));
   qs('#next3').addEventListener('click', () => goto(4));

   function renderFinal() {
     const f = qs('#finalSummary');
     f.innerHTML = `
       <div><strong>${state.name}</strong> 님의 예약 요청이 접수되었습니다.</div>
       <div class="muted">상담일시: ${state.consultDate} ${state.time}, 상담사: ${state.counselor}</div>
     `;
   }

   qs('#name').focus();

  document.addEventListener("DOMContentLoaded", () => {
 document.getElementById('submitBtn').addEventListener('click', async () => {
   const data = { ...state };
   const url = data.id ? `/reserve/psy_reserve/${data.id}` : '/reserve/save1';
   const method = data.id ? 'PUT' : 'POST';

   try {
     const response = await fetch(url, {
       method,
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify(data)
     });

     if (response.ok) {
       alert(data.id ? '예약이 성공적으로 수정되었습니다!' : '예약이 성공적으로 저장되었습니다!');
       const email = document.getElementById('email').value;
       window.location.href = `/mypage/Mypage?email=${encodeURIComponent(email)}`;
     } else {
       alert('저장 중 오류가 발생했습니다.');
     }
   } catch (err) {
     console.error('서버 통신 오류:', err);
     alert('서버 통신 중 오류가 발생했습니다.');
   }
 });
});
</script>
</body>
</html>
