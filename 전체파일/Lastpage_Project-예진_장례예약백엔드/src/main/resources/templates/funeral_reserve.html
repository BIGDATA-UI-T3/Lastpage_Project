<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>장례 예약 하기</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/Funeral_reserve.css">
</head>
<body>

<!-- 헤더(메인과 동일) -->
<div class="header-wrapper">
    <header>
        <div class="logo">
            <a href="/"><img src="/asset/LastPage로고_투명.png" alt="로고" /></a>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="/">홈</a>
                    <ul><li><a href="#">인사말</a></li></ul>
                </li>
                <li><a href="#">장례서비스</a></li>
                <li><a href="#">Ourpage</a></li>
                <li>
                    <a href="#">심리상담</a>
                    <ul>
                        <li><a href="#">상담예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">추모굿즈</a>
                    <ul>
                        <li><a href="#">굿즈소개</a></li>
                        <li><a href="#">굿즈예약</a></li>
                        <li><a href="#">예약조회</a></li>
                    </ul>
                </li>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">고객센터</a></li>
            </ul>
        </nav>
        <!-- 로그인 상태에 따라 전환 -->
        <div th:if="${loginUser != null}" class="auth">
            <a href="#" th:onclick="|logout()|">로그아웃</a>
        </div>
        <div th:if="${loginUser == null}" class="auth">
            <a href="/signin">로그인</a>
            <a href="/signup">회원가입</a>
        </div>
    </header>


    <!-- 배너 -->
    <section class="banner" role="img" aria-label="추모 굿즈 간편예약 배너">
        <div class="inner">
            <h1>사랑을 형태로 남기는 맞춤 제작</h1>
            <p>유골·모발·발자국 등 소중한 흔적으로 주얼리/액자/레진 오브제를 제작합니다.</p>
        </div>
    </section>
</div>


<!-- 본문: 장례 예약 폼 -->
<main>
    <form th:action="@{/reserve/save}" th:object="${reserveDto}" method="post" id="reserveForm" class="wrap">
        <input type="hidden" id="reserveId" th:field="*{id}" /> <!-- 수정 시 예약ID 저장 -->
        <input type="hidden" name="reserveId" th:value="${reserveDto.id}">

        <div class="card">
            <div class="steps" aria-label="예약 단계">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
                <div class="step-dot" id="dot4"></div>
            </div>

            <h1 class="title">장례 예약</h1>

            <!-- STEP 1 : 신청자 & 반려동물 정보 -->
            <section class="step active" id="step1">
                <div class="grid">
                    <div>
                        <label class="small">신청자명</label>
                        <div class="field"><input th:field="*{ownerName}" id="ownerName" type="text" placeholder="홍길동" required></div>
                    </div>
                    <div>
                        <label class="small">휴대폰번호</label>
                        <div class="field"><input th:field="*{ownerPhone}" id="ownerPhone" type="tel" inputmode="numeric" placeholder="01012345678" required></div>
                    </div>
                    <div>
                        <label class="small">이메일</label>
                        <div class="field"><input th:field="*{ownerEmail}" id="ownerEmail" type="email" placeholder="name@example.com" required></div>
                    </div>
                    <div>
                        <label class="small">주소</label>
                        <div class="field"><input th:field="*{ownerAddr}" id="ownerAddr" type="text" placeholder="시/구/동, 상세 주소" required></div>
                    </div>
                    <div>
                        <label class="small">반려동물 이름</label>
                        <div class="field"><input th:field="*{petName}" id="petName" type="text" placeholder="모모" required></div>
                    </div>

                    <!-- 드롭다운: 종류/품종 -->
                    <div>
                        <label class="small">반려동물 종류</label>
                        <div class="field">
                            <select id="petType" required>
                                <option value="">선택</option>
                                <option value="dog">개</option>
                                <option value="cat">고양이</option>
                                <option value="small">소동물</option>
                                <option value="other">기타</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="small">품종</label>
                        <div class="field">
                            <select id="petBreed" required disabled>
                                <option value="">종류 선택 먼저</option>
                            </select>
                            <input id="petBreedText" type="text" placeholder="직접 입력" style="display:none;">
                        </div>
                        <small class="muted">※ “기타” 선택 시 품종을 직접 입력하세요.</small>
                    </div>
                     <div>
                        <label class="small">체중(kg)</label>
                        <div class="field"><input th:field="*{petWeight}" id="petWeight" type="number" min="0" step="0.1" placeholder="4.2" required></div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" disabled>이전</button>
                    <button id="next1" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 2 : 장례 상세 -->
            <section class="step" id="step2">
                <div class="grid">
                    <div>
                        <label class="small">사망 일시</label>
                        <div class="field"><input th:field="*{passedAt}" id="passedAt" type="datetime-local" required></div>
                    </div>

                    <div>
                        <label class="small">예약 장소</label>
                        <div class="field">
                            <select id="place" required>
                                <option value="">(도시) 장례식장 선택</option>
                                <option>(경기 광주) 펫포레스트 경기광주점</option>
                                <option>(대구) 대구러브펫</option>
                                <option>(부산 기장) 스타티스</option>
                            </select>
                        </div>
                        <small class="note">형식 예시: (서울) 서울동물 장례식장</small>
                    </div>

                    <div>
                        <label class="small">장례 희망일</label>
                        <div class="field"><input th:field="*{funeralDate}" id="funeralDate" type="date" required></div>
                        <small class="note">오늘 이후 날짜만 선택</small>
                    </div>

                    <div>
                        <label class="small">장례 유형</label>
                        <div class="field">
                            <select id="type" required>
                                <option value="">선택</option>
                                <option>개별 화장</option>
                                <option>가족 입회 화장</option>
                                <option>합동 화장</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="small">유골 처리</label>
                        <div class="field">
                            <select id="ash" required>
                                <option value="">선택</option>
                                <option>유골함 보관</option>
                                <option>추모공간 안치(제휴)</option>
                                <option>자연장/산골(자가)</option>
                                <option>기타(메모에 기입)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="small">운구(픽업)</label>
                        <div class="field">
                            <select id="pickup">
                                <option selected>직접 방문</option>
                                <option>운구 요청</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 운구 추가 입력 -->
                <div class="grid" id="pickupExtra" style="display:none; margin-top:4px">
                    <div>
                        <label class="small">운구 주소</label>
                        <div class="field"><input id="pickupAddr" type="text" placeholder="도로명, 건물명 등 상세 주소"></div>
                    </div>
                    <div>
                        <label class="small">운구 희망 시간</label>
                        <div class="field"><input id="pickupTime" type="time"></div>
                    </div>
                </div>

                <div class="grid-1" style="margin-top:10px">
                    <div>
                        <label class="small">희망 시간 (1시간)</label>
                        <div class="seg">
                            <button class="seg-btn is-active" type="button" data-seg="am">오전</button>
                            <button class="seg-btn" type="button" data-seg="pm">오후</button>
                        </div>
                        <div id="timeSlots" class="slots" role="listbox" aria-label="시간 선택"></div>
                    </div>

                    <div>
                        <label class="small">요청사항(선택)</label>
                        <div class="field" style="align-items:start">
                            <textarea id="memo" rows="4" maxlength="300" placeholder="예: 가족 입회, 이동식 수습 지원 등"></textarea>
                        </div>
                        <div class="count"><span id="memoCount">0</span>/300</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev2">이전</button>
                    <button id="next2" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 3 : 확인 -->
            <section class="step" id="step3">
                <div class="grid-1">
                    <div class="field" style="justify-content:center">
                        <strong>입력한 예약 내용을 확인해 주세요.</strong>
                    </div>
                    <div class="summary" id="summary"></div>
                    <label class="field" style="gap:10px">
                        <input type="checkbox" id="confirmChk" />
                        <span>입력한 내용이 정확합니다.</span>
                    </label>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev3">이전</button>
                    <button id="next3" class="btn primary" type="button" disabled>다음</button>
                </div>
            </section>

            <!-- STEP 4 : 완료 -->
            <section class="step" id="step4">
                <div class="grid-1">
                    <div class="field" style="justify-content:center">
                        <strong>예약 요청이 완료되었습니다.</strong>
                    </div>
                    <div class="summary" id="finalSummary"></div>
                    <small class="muted">※ 실제 제출은 백엔드 API에 연결해 처리하세요.</small>
                </div>

                <div class="actions">
                    <button class="btn secondary" type="button" id="prev4">이전</button>
                    <button class="btn" id ="submitBtn" type="button" onclick="submitReserve()">제출하기</button>
                </div>
            </section>
        </div>

        <!-- 서버로 전송될 실제 값들 -->
        <input type="hidden" name="petType" id="h_petType">
        <input type="hidden" name="petBreed" id="h_petBreed">
        <input type="hidden" name="place" id="h_place">
        <input type="hidden" name="funeralDate" id="h_funeralDate">
        <input type="hidden" name="type" id="h_type">
        <input type="hidden" name="ash" id="h_ash">
        <input type="hidden" name="pickup" id="h_pickup">
        <input type="hidden" name="pickupAddr" id="h_pickupAddr">
        <input type="hidden" name="pickupTime" id="h_pickupTime">
        <input type="hidden" name="time" id="h_time">
        <input type="hidden" name="memo" id="h_memo">

    </form>
</main>

<!-- 푸터(메인과 동일) -->
<footer>
    대충 연락처 / GitHub 주소 / 이메일 등 입력 예정/ 푸터 높이는 헤더 배너 반응 테스트용.
</footer>

<!-- 공통 스크립트: 헤더 숨김 -->
<script>
    (function () {
        const header = document.querySelector('header');
        window.addEventListener('scroll', () => {
            header.style.top = (window.scrollY > 200) ? '-120px' : '0';
        });
    })();
</script>

<!-- 로그아웃 -->
<script>
    function logout() {
        fetch("/logout", { method: "POST" })
            .then(() => window.location.href = "/");
    }
</script>

<script th:inline="javascript">

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const ST = {
        id: null,  // 예약 수정용 ID
        ownerName:"", ownerPhone:"", ownerEmail:"", ownerAddr:"",
        petName:"", petType:"", petBreed:"", petWeight:"",
        passedAt:"", place:"", funeralDate:"", type:"", ash:"",
        pickup:"직접 방문", pickupAddr:"", pickupTime:"",
        time:"", memo:""
    };

    // 품종 데이터
    const BREEDS = {
        dog: ["말티즈","푸들","시바","리트리버","포메라니안","믹스"],
        cat: ["코리안숏헤어","페르시안","러시안블루","먼치킨","랙돌","믹스"],
        small: ["햄스터","토끼","기니피그","패럿","앵무새"]
    };

    // 날짜 제한
    (function setLimits(){
        const t = new Date();
        const yyyy = t.getFullYear(), mm = String(t.getMonth()+1).padStart(2,'0'), dd = String(t.getDate()).padStart(2,'0');
        const hh = String(t.getHours()).padStart(2,'0'), mi = String(t.getMinutes()).padStart(2,'0');
        $('#funeralDate').min = `${yyyy}-${mm}-${dd}`;
        $('#passedAt').max = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    })();

    // 페이지 로드 시 수정모드 확인
    document.addEventListener("DOMContentLoaded", () => {
        const path = location.pathname.split("/");
        const idFromPath = path[path.length - 1];
        const id = Number(idFromPath) ? idFromPath : null;

        if (id) {
            ST.id = id;
            loadReserveData(id);
        }
    });

    // 수정모드 시 기존 데이터 불러오기
    function loadReserveData(id) {
        fetch(`/reserve/detail/${id}`)
            .then(res => res.json())
            .then(data => {
                $('#ownerName').value = data.ownerName;
                $('#ownerPhone').value = data.ownerPhone;
                $('#ownerEmail').value = data.ownerEmail;
                $('#ownerAddr').value = data.ownerAddr;
                $('#petName').value = data.petName;
                $('#petType').value = data.petType;
                $('#petWeight').value = data.petWeight;
                $('#passedAt').value = data.passedAt;
                $('#place').value = data.place;
                $('#funeralDate').value = data.funeralDate;
                $('#type').value = data.type;
                $('#ash').value = data.ash;
                $('#pickup').value = data.pickup;
                $('#memo').value = data.memo;

                Object.assign(ST, data);

                ST.id = id;

                renderSummary();

                // 선택 초기화 실행
                const petTypeSelect = document.getElementById("petType");
                petTypeSelect.value = ST.petType;
                petTypeSelect.dispatchEvent(new Event("change"));

                if (ST.petType === "other") {
                    document.getElementById("petBreedText").style.display = "block";
                    document.getElementById("petBreedText").value = ST.petBreed ?? "";
                } else {
                    document.getElementById("petBreed").value = ST.petBreed ?? "";
                }

            })
            .catch(err => console.error('불러오기 실패', err));
    }

    // STEP 이동
    function gotoStep(n){
        $$('.step').forEach((el,i)=> el.classList.toggle('active', i===n-1));
        $$('.step-dot').forEach((d,i)=> d.classList.toggle('active', i<=n-1));
        window.scrollTo({top:0, behavior:'smooth'});
        if(n===3) renderSummary();
        if(n===4) renderFinal();
    }

    // STEP1: 신청자 & 반려동물
    const petTypeEl = $('#petType');
    const petBreedSel = $('#petBreed');
    const petBreedText = $('#petBreedText');

    petTypeEl.addEventListener('change', () => {
        const type = petTypeEl.value;
        ST.petType = type;
        if(!type){
            petBreedSel.innerHTML = '<option value="">종류 선택 먼저</option>';
            petBreedSel.disabled = true;
            petBreedText.style.display='none';
            petBreedText.value='';
            v1(); return;
        }
        if(type==='other'){
            petBreedSel.disabled = true;
            petBreedSel.innerHTML = '<option value="">직접 입력</option>';
            petBreedText.style.display='block';
            ST.petBreed = petBreedText.value.trim();
        }else{
            petBreedSel.disabled = false;
            petBreedText.style.display='none';
            petBreedText.value='';
            petBreedSel.innerHTML = '<option value="">품종 선택</option>' + BREEDS[type].map(b=>`<option>${b}</option>`).join('');
            ST.petBreed = '';
        }
        v1();
    });

    petBreedSel.addEventListener('change', ()=> { ST.petBreed = petBreedSel.value; v1(); });
    petBreedText.addEventListener('input', ()=> { ST.petBreed = petBreedText.value.trim(); v1(); });

    function v1(){
        const name = $('#ownerName').value.trim();
        const phone = $('#ownerPhone').value.replace(/\D/g,'');
        const email = $('#ownerEmail').value.trim();
        const addr = $('#ownerAddr').value.trim();
        const pnm = $('#petName').value.trim();
        const pwt = $('#petWeight').value.trim();

        ST.ownerName=name; ST.ownerPhone=phone; ST.ownerEmail=email; ST.ownerAddr=addr;
        ST.petName=pnm; ST.petWeight=pwt;

        const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        const breedOK = (ST.petType==='other') ? !!ST.petBreed : (!!ST.petType && !!ST.petBreed);

        const ok = name && phone.length>=10 && emailOK && addr && pnm && breedOK && Number(pwt)>=0;
        $('#next1').disabled = !ok;
    }
    $$('#step1 input, #step1 select').forEach(el=> el.addEventListener('input', v1));
    $('#next1').addEventListener('click', ()=> gotoStep(2));
    v1();

    // STEP2: 장례 상세
    const AM = ["07:00","07:30","08:00","08:30","09:00","09:30","10:00","10:30","11:00","11:30"];
    const PM = ["12:00","12:30","13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30","17:00","17:30","18:00"];
    let currentSeg='am', selectedBtn=null;

    function buildSlots(){
        const list = currentSeg==='am' ? AM : PM;
        const box = $('#timeSlots'); box.innerHTML='';
        list.forEach(t=>{
            const b=document.createElement('button');
            b.type='button'; b.className='slot'; b.textContent=t; b.dataset.value=t;
            b.addEventListener('click', ()=>{
                selectedBtn?.classList.remove('active');
                b.classList.add('active'); selectedBtn=b;
                ST.time=t; v2();
            });
            box.appendChild(b);
        });
    }
    buildSlots();
    $$('.seg-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
            $('.seg-btn.is-active')?.classList.remove('is-active');
            b.classList.add('is-active');
            currentSeg=b.dataset.seg; buildSlots();
        });
    });

    $('#memo').addEventListener('input', e=>{
        $('#memoCount').textContent = e.target.value.length;
        ST.memo = e.target.value;
    });

    $('#pickup').addEventListener('change', ()=>{
        const need = $('#pickup').value === '운구 요청';
        $('#pickupExtra').style.display = need ? 'grid' : 'none';
        if(!need){ $('#pickupAddr').value=''; $('#pickupTime').value=''; }
        v2();
    });

    function v2(){
        ST.passedAt = $('#passedAt').value;
        ST.place = $('#place').value;
        ST.funeralDate = $('#funeralDate').value;
        ST.type = $('#type').value;
        ST.ash = $('#ash').value;
        ST.pickup = $('#pickup').value;

        let ok = !!ST.passedAt && !!ST.place && !!ST.funeralDate && !!ST.type && !!ST.ash && !!ST.time;

        if(ST.pickup==='운구 요청'){
            ST.pickupAddr = $('#pickupAddr').value.trim();
            ST.pickupTime = $('#pickupTime').value;
            ok = ok && !!ST.pickupAddr && !!ST.pickupTime;
        }else{
            ST.pickupAddr=''; ST.pickupTime='';
        }
        $('#next2').disabled = !ok;
    }
    $$('#passedAt, #place, #funeralDate, #type, #ash, #pickup, #pickupAddr, #pickupTime').forEach(el=> el.addEventListener('input', v2));
    $('#prev2').addEventListener('click', ()=> gotoStep(1));
    $('#next2').addEventListener('click', ()=> gotoStep(3));

    // STEP3: 요약
    function renderSummary(){
        const pickupInfo = ST.pickup === '운구 요청'
            ? `${ST.pickup} / 주소: ${ST.pickupAddr} / 시간: ${ST.pickupTime}`
            : ST.pickup;

        $('#summary').innerHTML = `
        <div><strong>신청자 정보</strong></div>
        <ul>
            <li>이름: ${ST.ownerName}</li>
            <li>휴대폰: ${ST.ownerPhone}</li>
            <li>이메일: ${ST.ownerEmail}</li>
            <li>주소: ${ST.ownerAddr}</li>
        </ul>

        <div><strong>반려동물 정보</strong></div>
        <ul>
            <li>이름: ${ST.petName}</li>
            <li>종류: ${ST.petType}</li>
            <li>품종: ${ST.petBreed}</li>
            <li>체중: ${ST.petWeight} kg</li>
        </ul>

        <div><strong>장례 정보</strong></div>
        <ul>
            <li>사망 일시: ${ST.passedAt}</li>
            <li>장례식장: ${ST.place}</li>
            <li>장례일: ${ST.funeralDate}</li>
            <li>장례 유형: ${ST.type}</li>
            <li>유골 처리: ${ST.ash}</li>
            <li>운구: ${pickupInfo}</li>
        </ul>

        <div><strong>요청사항</strong></div>
        <p>${ST.memo || '없음'}</p>
    `;
        // 체크박스 상태에 따라 next3 활성화 상태 설정
        $('#next3').disabled = !$('#confirmChk').checked;
    }

    // STEP4: 최종
    function renderFinal(){
        $('#finalSummary').innerHTML = `<pre>${JSON.stringify(ST,null,2)}</pre>`;
        $('#submitBtn').disabled = false;
    }

    // 체크박스 감지
    $('#confirmChk').addEventListener('change', () => {
        $('#next3').disabled = !$('#confirmChk').checked;
    });

    // STEP 3 이동 버튼 이벤트
    $('#prev3').addEventListener('click', () => {
        gotoStep(2);   // 이전 스텝으로 이동
    });

    $('#next3').addEventListener('click', () => {
        gotoStep(4);   // 최종 확인 스텝으로 이동
    });


    // 제출
    function submitReserve(){
        var isLoggedIn = /*[[${loginUser != null}]]*/ false;
        if(!isLoggedIn){
            alert("로그인 후 이용 가능합니다.");
            window.location.href="/signin";
            return;
        }

        // ST 값 → hidden input에 반영
        $('#h_petType').value = ST.petType;
        $('#h_petBreed').value = ST.petBreed;
        $('#h_place').value = ST.place;
        $('#h_funeralDate').value = ST.funeralDate;
        $('#h_type').value = ST.type;
        $('#h_ash').value = ST.ash;
        $('#h_pickup').value = ST.pickup;
        $('#h_pickupAddr').value = ST.pickupAddr;
        $('#h_pickupTime').value = ST.pickupTime;
        $('#h_time').value = ST.time;
        $('#h_memo').value = ST.memo;

        const url = ST.id ? `/reserve/update/${ST.id}` : '/reserve/save';

        fetch(url, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials: "include",
            body: JSON.stringify(ST)
        })
            .then(res => res.ok ? res.json() : Promise.reject('저장 실패'))
            .then(data => {
                alert(ST.id ? '예약이 수정되었습니다.' : '예약이 완료되었습니다!');
                renderFinal();
                gotoStep(4);
            })
            .catch(err => {
                console.error(err);
                alert('예약 저장 중 오류가 발생했습니다.');
            });
    }


</script>

</body>
</html>
